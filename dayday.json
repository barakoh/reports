{
  "name": "Portfolio Pension Expert - Route Recommendations",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "pension-expert",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "7541f645-5cf1-47e3-978c-9756f8d4218e",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        31536,
        30624
      ],
      "webhookId": "pension-expert-webhook"
    },
    {
      "parameters": {
        "jsCode": "const BLACKLIST = [' 驻转', '驻'];\n\n  const PRODUCT_CODES = {\n    PENSION: [1, 2, 19],\n    GEMEL: [3, 5, 6],\n    GEMEL_INVEST: [4],\n    HISHTALMUT: [7],\n    SAVINGS: [41],\n    INSURANCE: [8, 13, 14, 15]\n  };\n\n  const GEMELNET_RESOURCE = 'a30dcbea-a1d2-482c-ae29-8f781f5025fb';       \n  const PENSIANET_RESOURCE = '6d47d6b5-cb08-488b-b333-f1e717b1e1bd';      \n  const BITUACHNET_RESOURCE = 'c6c62cc7-fe02-4b18-8f3e-813abfbb4647';     \n  const DATA_GOV_BASE = 'https://data.gov.il/api/3/action/datastore_search';\n\n  // 驻 companyId 砖 专\n  const COMPANY_NAMES = {\n    1: '',\n    2: '专',\n    3: '',\n    4: '驻拽住',\n    5: '专 ',\n    6: '',\n    7: '砖专',\n    8: ' 砖专',\n    9: '砖',\n    10: '砖专 砖',\n    11: ' 砖',\n    12: '驻住转',\n    13: '住',\n    14: '专',\n    15: ' 驻转',\n    16: '驻',\n    17: '专 驻住',\n    18: ' 砖拽 ',\n    52: '专 '\n  };\n\n  function getCompanyName(companyId, fallbackName) {\n    return COMPANY_NAMES[companyId] || fallbackName || '';\n  }\n\n\n\n  function getProductTypeName(code) {\n    const types = {\n      1: '拽专 驻住', 2: '拽专 驻住', 19: '拽专 驻住',\n      3: '拽驻转 ', 4: ' 砖拽注', 5: '拽驻转 ', 6: '拽驻转 ',       \n      7: '拽专 砖转转',\n      13: ' ', 14: ' ', 15: ' ',\n      41: '驻住转 住'\n    };\n    return types[code] || ' 注';\n  }\n\n  function getProductCategory(code) {\n    if (PRODUCT_CODES.PENSION.includes(code)) return 'pension';\n    if (PRODUCT_CODES.GEMEL.includes(code)) return 'gemel';\n    if (PRODUCT_CODES.GEMEL_INVEST.includes(code)) return 'gemel_invest'; \n    if (PRODUCT_CODES.HISHTALMUT.includes(code)) return 'hishtalmut';     \n    if (PRODUCT_CODES.SAVINGS.includes(code)) return 'savings';\n    if (PRODUCT_CODES.INSURANCE.includes(code)) return 'insurance';       \n    return 'other';\n  }\n\n  function getProductBadgeClass(code) {\n    if (PRODUCT_CODES.PENSION.includes(code)) return 'badge-pension';     \n    if (PRODUCT_CODES.HISHTALMUT.includes(code)) return 'badge-hishtalmut';\n    if (PRODUCT_CODES.GEMEL.includes(code) || PRODUCT_CODES.GEMEL_INVEST.includes(code)) return 'badge-gemel';\n    if (PRODUCT_CODES.INSURANCE.includes(code)) return 'badge-insurance'; \n    if (PRODUCT_CODES.SAVINGS.includes(code)) return 'badge-savings';     \n    return '';\n  }\n\n  function getStatusInfo(product) {\n    const status = product.status || product.maamad?.status;\n    if (!status) return { code: 0, description: ' 注' };\n    return { code: status.code || 0, description: status.description || (status.code === 1 ? '驻注' : ' 驻注') };\n  }\n\n  function getEmploymentStatus(code) {\n    return code === 1 ? '砖专' : '注爪';\n  }\n\n  function needsGemelNet(typeCode) {\n    return PRODUCT_CODES.GEMEL.includes(typeCode) || PRODUCT_CODES.GEMEL_INVEST.includes(typeCode) || PRODUCT_CODES.HISHTALMUT.includes(typeCode);  \n  }\n\n  function needsPensionNet(typeCode) {\n    return PRODUCT_CODES.PENSION.includes(typeCode);\n  }\n\n  function needsBituachNet(typeCode) {\n    return PRODUCT_CODES.SAVINGS.includes(typeCode) || PRODUCT_CODES.INSURANCE.includes(typeCode);\n  }\n\n  // 住 驻住- (拽驻/转)\n  function getPensionClassification(productTypeCode) {\n    if (productTypeCode === 1) return '拽专转 砖转';\n    if (productTypeCode === 19) return '拽专转 转';\n    return null;\n  }\n\n  // 住 -\n  function getFundClassification(productTypeCode) {\n    if (productTypeCode === 7) return '拽专转 砖转转';\n    if (productTypeCode === 4) return '拽驻转  砖拽注';\n    if ([3, 5, 6].includes(productTypeCode)) return '转 砖转 驻爪';\n    return null;\n  }\n\n  // URL 驻 .驻 专 + 住\n  function buildGemelNetUrl(companyIdNumber, productTypeCode) {\n    const classification = getFundClassification(productTypeCode);        \n    const filters = { MANAGING_CORPORATION_LEGAL_ID: Number(companyIdNumber) };\n    if (classification) {\n      filters.FUND_CLASSIFICATION = classification;\n    }\n    return DATA_GOV_BASE + '?resource_id=' + GEMELNET_RESOURCE + '&filters=' + encodeURIComponent(JSON.stringify(filters)) + '&sort=REPORT_PERIOD%20desc&limit=100';\n  }\n\n  function buildPensionNetUrl(companyIdNumber, productTypeCode) {\n    const classification = getPensionClassification(productTypeCode);\n    const filters = { MANAGING_CORPORATION_LEGAL_ID: Number(companyIdNumber) };\n    if (classification) {\n      filters.FUND_CLASSIFICATION = classification;\n    }\n    return DATA_GOV_BASE + '?resource_id=' + PENSIANET_RESOURCE + '&filters=' + encodeURIComponent(JSON.stringify(filters)) + '&sort=REPORT_PERIOD%20desc&limit=100';\n  }\n\n  // -: 住 砖专 驻 FUND_ID\n  function buildBituachNetUrl(trackCode) {\n    const filters = { FUND_ID: String(trackCode) };\n    return DATA_GOV_BASE + '?resource_id=' + BITUACHNET_RESOURCE + '&filters=' + encodeURIComponent(JSON.stringify(filters)) + '&sort=REPORT_PERIOD%20desc&limit=1';\n  }\n\n  // Fallback: search by company + partial name match\n  function buildBituachNetUrlByName(trackName, companyIdNumber) {\n    const filters = { PARENT_COMPANY_LEGAL_ID: Number(companyIdNumber) };\n    return DATA_GOV_BASE + '?resource_id=' + BITUACHNET_RESOURCE + '&filters=' + encodeURIComponent(JSON.stringify(filters)) + '&sort=REPORT_PERIOD%20desc&limit=200';\n  }\n\n  function daysDiff(dateStr) {\n    if (!dateStr) return 999;\n    const date = new Date(dateStr);\n    const currentDate = new Date();\n    return Math.floor((currentDate - date) / (1000 * 60 * 60 * 24));      \n  }\n\n  const inputData = $input.first().json;\n  const shuranceData = inputData.body || inputData;\n  const products = shuranceData.body?.products || shuranceData.products || [];\n\n  const portfolioItems = [];\n  const criticalAlerts = [];\n  const productTypesSet = new Set();\n  const gemelApiCalls = [];\n  const pensionApiCalls = [];\n  const bituachApiCalls = [];\n\n  // 拽抓 驻 .驻 + 住 爪专\n  const processedGemelKeys = new Set();\n  const processedPensionKeys = new Set();\n  const processedBituachTracks = new Set();\n  const processedBituachKeys = new Set();\n\n  // Calculate age from birthDate\n  function calculateAge(birthDate) {\n    if (!birthDate) return null;\n    const birth = new Date(birthDate);\n    const today = new Date();\n    let age = today.getFullYear() - birth.getFullYear();\n    const monthDiff = today.getMonth() - birth.getMonth();\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {\n      age--;\n    }\n    return age;\n  }\n\n  // Customer info comes directly from the HTTP request (from Get Customer node)\n  const birthDate = shuranceData.birthDate || null;\n  const calculatedAge = calculateAge(birthDate);\n\n  const customerInfo = {\n    customerName: shuranceData.customerName || '拽',\n    customerId: shuranceData.idNumber || null,\n    age: calculatedAge,\n    birthDate: birthDate,\n    employmentStatus: null,\n    address: shuranceData.address || '',\n    phone: shuranceData.phone || '',\n    email: shuranceData.email || ''\n  };\n\n  for (const product of products) {\n    const productTypeCode = product.type?.code;\n    const productType = getProductTypeName(productTypeCode);\n    const productCategory = getProductCategory(productTypeCode);\n    const badgeClass = getProductBadgeClass(productTypeCode);\n    const statusInfo = getStatusInfo(product);\n    const employmentStatus = getEmploymentStatus(product.maamad?.code);   \n    const companyName = product.companyName || getCompanyName(product.companyId, '') || '';\n    const companyId = product.companyId || 0;\n    const companyIdNumber = product.companyIdNumber || 0;\n    const fundCode = product.misparMemHei || null;\n\n    if (productTypeCode) productTypesSet.add(productTypeCode);\n    if (!customerInfo.employmentStatus) customerInfo.employmentStatus = employmentStatus;\n\n    if (PRODUCT_CODES.PENSION.includes(productTypeCode) && statusInfo.code === 2) {\n      criticalAlerts.push({\n        severity: 'CRITICAL', type: 'RISK_STATUS',\n        productName: product.shemTohnit || productType,\n        productNumber: product.accountPolicyNumber || '',\n        message: ' 拽专 驻住 \"' + (product.shemTohnit || productType) +\n '\" 爪 专住拽 !',\n        action: '专砖 驻  - 拽  注住拽'\n      });\n    }\n\n    if (employmentStatus === '砖专' && PRODUCT_CODES.PENSION.includes(productTypeCode)) {\n      const lastDeposit = product.lastDeposit?.hafkadot?.[0];\n      if (lastDeposit && lastDeposit.taarihEreh) {\n        const daysGap = daysDiff(lastDeposit.taarihEreh);\n        if (daysGap >= 60) {\n          criticalAlerts.push({\n            severity: 'HIGH', type: 'MISSING_DEPOSITS',\n            productName: product.shemTohnit || productType,\n            productNumber: product.accountPolicyNumber || '',\n            lastDeposit: lastDeposit.taarihEreh, daysGap: daysGap,        \n            message: '锔  转拽 驻拽 -\"' + (product.shemTohnit || prooductType) + '\"  ' + lastDeposit.taarihEreh + ' (' + daysGap + ' )',\n            action: '砖 拽  注住拽'\n          });\n        }\n      }\n    }\n\n    if (product.masluleiAshkaa && product.masluleiAshkaa.length > 0) {    \n      for (const maslul of product.masluleiAshkaa) {\n        const trackCode = maslul.code;\n        const trackKey = String(trackCode);\n\n        portfolioItems.push({\n          fundCode, trackCode, productTypeCode, productType, productCategory,\n          productBadgeClass: badgeClass,\n          productName: product.shemTohnit || productType,\n          productNumber: product.accountPolicyNumber || '',\n          companyId, companyIdNumber, companyName,\n          trackName: maslul.name,\n          trackAccumulation: maslul.accumulation || 0,\n          trackPercent: Math.round((maslul.accumulation / (product.accumulation || 1)) * 100) || 0,\n          productAccumulation: product.accumulation || 0,\n          accumulationFee: (product.accumulationFee || 0) * 100,\n          depositFee: (product.depositFee || 0) * 100,\n          statusCode: statusInfo.code,\n          statusDescription: statusInfo.description,\n          employmentStatus,\n          lastDepositDate: product.lastDeposit?.hafkadot?.[0]?.taarihEreh || null,\n          lastDepositMonth: product.lastDeposit?.hafkadot?.[0]?.month || null,\n          lastDepositAmount: product.lastDeposit?.hafkadot?.[0]?.total || 0,\n          salary: product.maamad?.salary || 0,\n          employerName: product.lastDeposit?.hafkadot?.[0]?.shemMaasik || '',\n          // Pension-specific fields - using collection objects\n          insuredSalary: product.insuredSalary || 0,\n          kitzbatNehut: product.kitzbatNehut?.amount || product.pensionDisabilityAllowance || 0,\n          kitzbaLeAlman: product.kitzbaLeAlman?.amount || product.partnerAllowance || 0,\n          kitzbaLeYetom: product.kitzbaLeYetom?.amount || product.orphanAllowance || 0,\n          kitzbatZiknaKolelPremiot: product.kitzbatZiknaKolelPremiot || product.swKitzbatZiknaKolelPremiot || 0,\n          retirementAge: product.swGilPrishaLeHishuvTahaziot || 67,\n          // Insurance coverage percentages (住 )\n          disabilityCoverage: product.pensionDisabilityCoverage || 0,\n          partnerCoverage: product.partnerCoverage || 0,\n          orphanCoverage: product.orphanCoverage || 0\n        });\n\n        // 拽抓 驻 .驻 + 住 爪专\n        if (needsGemelNet(productTypeCode) && companyIdNumber) {\n          const key = companyIdNumber + '_' + productTypeCode;\n          if (!processedGemelKeys.has(key)) {\n            processedGemelKeys.add(key);\n            gemelApiCalls.push({\n              companyIdNumber,\n              companyName,\n              productTypeCode,\n              productType,\n              customerTrackCodes: [trackKey],\n              apiUrl: buildGemelNetUrl(companyIdNumber, productTypeCode)  \n            });\n          } else {\n            const existing = gemelApiCalls.find(c => c.companyIdNumber === companyIdNumber && c.productTypeCode === productTypeCode);\n            if (existing && !existing.customerTrackCodes.includes(trackKey)) {\n              existing.customerTrackCodes.push(trackKey);\n            }\n          }\n        } else if (needsPensionNet(productTypeCode) && companyIdNumber) { \n          const key = companyIdNumber + '_' + productTypeCode;\n          if (!processedPensionKeys.has(key)) {\n            processedPensionKeys.add(key);\n            pensionApiCalls.push({\n              companyIdNumber,\n              companyName,\n              productTypeCode,\n              productType,\n              customerTrackCodes: [trackKey],\n              apiUrl: buildPensionNetUrl(companyIdNumber, productTypeCode)\n            });\n          } else {\n            const existing = pensionApiCalls.find(c => c.companyIdNumber === companyIdNumber && c.productTypeCode === productTypeCode);\n            if (existing && !existing.customerTrackCodes.includes(trackKey)) {\n              existing.customerTrackCodes.push(trackKey);\n            }\n          }\n        } else if (needsBituachNet(productTypeCode)) {\n          // Support both trackCode and name-based lookup\n          if (trackCode && !processedBituachTracks.has(trackKey)) {\n            processedBituachTracks.add(trackKey);\n            bituachApiCalls.push({\n              trackCode,\n              trackName: maslul.name,\n              companyIdNumber,\n              companyName,\n              productTypeCode,\n              productType,\n              searchByName: false,\n              apiUrl: buildBituachNetUrl(trackCode)\n            });\n          } else if (!trackCode && maslul.name) {\n            // Fallback: search by name if no trackCode\n            const nameKey = companyIdNumber + '_' + maslul.name;\n            if (!processedBituachTracks.has(nameKey)) {\n              processedBituachTracks.add(nameKey);\n              bituachApiCalls.push({\n                trackCode: null,\n                trackName: maslul.name,\n                companyIdNumber,\n                companyName,\n                productTypeCode,\n                productType,\n                searchByName: true,\n                apiUrl: buildBituachNetUrlByName(maslul.name, companyIdNumber)\n              });\n            }\n          }\n        }\n      }\n    }\n  }\n\n  const productTypes = Array.from(productTypesSet);\n  const summaryStats = {\n    totalAccumulation: shuranceData.tzvira?.amount || 0,\n    projectedPension: shuranceData.kitzbaHazuyaKolelPremiot?.amount || 0, \n    ytdReturn: shuranceData.tsuaMithilatShana?.amount || 0,\n    monthlyDeposit: 0\n  };\n\n  for (const product of products) {\n    if (product.lastDeposit?.hafkadot?.[0]) {\n      summaryStats.monthlyDeposit += product.lastDeposit.hafkadot[0].total || 0;\n    }\n  }\n\n  return {\n    json: {\n      customerInfo, portfolioItems, summaryStats, criticalAlerts, productTypes,\n      needGemelNet: gemelApiCalls.length > 0,\n      needPensionNet: pensionApiCalls.length > 0,\n      needBituachNet: bituachApiCalls.length > 0,\n      gemelApiCalls, pensionApiCalls, bituachApiCalls,\n      blacklist: BLACKLIST,\n      productCodes: PRODUCT_CODES,\n      originalProducts: products\n    }\n  };"
      },
      "id": "ecf86f59-a60e-4f27-8a9b-135df22e5ef6",
      "name": "Parse Portfolio + Alerts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31760,
        30624
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needGemelNet }}",
              "value2": true
            }
          ]
        }
      },
      "id": "dab428c1-cb72-4385-aee9-92a23607d703",
      "name": "If Gemel Net Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        31984,
        30496
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needPensionNet }}",
              "value2": true
            }
          ]
        }
      },
      "id": "90f71bfd-e0d9-4e6b-af7b-9cb61bfa265f",
      "name": "If Pension Net Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        31984,
        30720
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needBituachNet }}",
              "value2": true
            }
          ]
        }
      },
      "id": "9c08c0c5-a250-49b2-86f3-63f35494473f",
      "name": "If Bituach Net Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        31984,
        30912
      ]
    },
    {
      "parameters": {
        "jsCode": "const apiCalls = $('Parse Portfolio + Alerts').first().json.gemelApiCalls || [];\nreturn apiCalls.map(item => ({ json: item }));"
      },
      "id": "086886af-2f84-46c0-b872-f86f97fba798",
      "name": "Split Gemel Tracks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32208,
        30480
      ]
    },
    {
      "parameters": {
        "jsCode": "const apiCalls = $('Parse Portfolio + Alerts').first().json.pensionApiCalls || [];\nreturn apiCalls.map(item => ({ json: item }));"
      },
      "id": "da40db4f-603e-40cd-ad46-37ec158d0dd6",
      "name": "Split Pension Tracks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32208,
        30720
      ]
    },
    {
      "parameters": {
        "jsCode": "const apiCalls = $('Parse Portfolio + Alerts').first().json.bituachApiCalls || [];\nreturn apiCalls.map(item => ({ json: item }));"
      },
      "id": "3b7b879a-b02a-40d8-a616-f07bfe7b7254",
      "name": "Split Bituach Tracks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32208,
        30912
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.apiUrl }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "636fe294-c6e9-40db-87c8-35f6cee8e983",
      "name": "Gemel Net API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32448,
        30480
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.apiUrl }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "e5b37af3-c870-47c9-b170-780550158990",
      "name": "Pension Net API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32448,
        30720
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.apiUrl }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "5faa7ba0-80b4-411f-8d68-ca9932910eaf",
      "name": "Bituach Net API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32448,
        30912
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE GEMEL RESULTS - 注 Top 3 转专转 =====\nconst results = [];\nconst splitItems = $('Split Gemel Tracks').all();\n\nfor (let i = 0; i < $input.all().length; i++) {\n  const item = $input.all()[i];\n  const splitItem = splitItems[i]?.json || {};\n  const records = item.json?.result?.records || [];\n  const customerTrackCodes = splitItem.customerTrackCodes || [];\n  \n  // 砖 1: 专砖 专  FUND_ID\n  const latestByFundId = {};\n  for (const rec of records) {\n    const fundId = String(rec.FUND_ID);\n    if (!latestByFundId[fundId] || rec.REPORT_PERIOD > latestByFundId[fundId].REPORT_PERIOD) {\n      latestByFundId[fundId] = rec;\n    }\n  }\n  \n  // 砖 2: 转 专砖转  住 注 砖 砖驻\n  const allTracks = Object.values(latestByFundId).map(rec => {\n    const assets = parseFloat(rec.TOTAL_ASSETS || 1);\n    const exposure = parseFloat(rec.STOCK_MARKET_EXPOSURE || 0);\n    return {\n      fundId: String(rec.FUND_ID),\n      fundName: rec.FUND_NAME || '',\n      ytdYield: parseFloat(rec.YEAR_TO_DATE_YIELD || 0),\n      yield3Y: parseFloat(rec.AVG_ANNUAL_YIELD_TRAILING_3YRS || 0),\n      stockExposure: assets > 0 ? (exposure / assets) * 100 : 0,\n      totalAssets: assets,\n      managingCorp: rec.MANAGING_CORPORATION || '',\n      fundClassification: rec.FUND_CLASSIFICATION || '',\n      mgmtFee: parseFloat(rec.AVG_ANNUAL_MANAGEMENT_FEE || 0)\n    };\n  });\n  \n  // 砖 3:  驻 转砖 ( )\n  allTracks.sort((a, b) => b.ytdYield - a.ytdYield);\n  \n  // 砖 4: Top 3\n  const top3 = allTracks.slice(0, 3).map((t, idx) => ({\n    ...t,\n    rank: idx + 1\n  }));\n  \n  // 砖 5: 专转 专砖  住 砖 拽\n  for (const trackCode of customerTrackCodes) {\n    const customerTrack = allTracks.find(t => t.fundId === trackCode);\n    \n    // 砖 专 拽 拽转 转专\n    // 砖 专 住\n    const rankIndex = allTracks.findIndex(t => t.fundId === trackCode);\n    const ranking = rankIndex >= 0 ? rankIndex + 1 : null;\n    \n    // 拽转 专: 专拽   -TOP 3 + 砖驻  (卤15%) + 转砖  -7%+\n    let hasAlert = false;\n    let betterTrack = null;\n    \n    if (customerTrack && ranking > 3) {\n      for (const track of allTracks) {\n        if (track.fundId === trackCode) continue;\n        const exposureDiff = Math.abs(track.stockExposure - customerTrack.stockExposure);\n        const yieldDiff = track.ytdYield - customerTrack.ytdYield;\n        \n        if (exposureDiff <= 15 && yieldDiff >= 7) {\n          hasAlert = true;\n          betterTrack = track;\n          break;\n        }\n      }\n    }\n    \n    \n    \n    results.push({\n      json: {\n        trackCode,\n        trackName: customerTrack?.fundName || splitItem.trackName || '',\n        productTypeCode: splitItem.productTypeCode,\n        companyId: splitItem.companyId,\n        companyName: splitItem.companyName,\n        // 转 住 \n        stockExposure: customerTrack?.stockExposure || null,\n        ytdYield: customerTrack?.ytdYield || null,\n        yield3Y: customerTrack?.yield3Y || null,\n        totalAssets: customerTrack?.totalAssets || null,\n        managingCorp: customerTrack?.managingCorp || '',\n        fundClassification: customerTrack?.fundClassification || '',\n        mgmtFee: customerTrack?.mgmtFee || null,\n        // 爪转\n        ranking,\n        totalTracks: allTracks.length,\n        top3,\n        allTracks,\n        hasAlert,\n        betterTrack,\n        // \n        source: 'GEMELNET',\n        hasData: customerTrack !== undefined\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "2be1fc6c-1600-4561-9c0b-53b7789b9b74",
      "name": "Parse Gemel Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32672,
        30480
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE PENSION RESULTS - 注 Top 3 转专转 =====\nconst results = [];\nconst splitItems = $('Split Pension Tracks').all();\n\nfor (let i = 0; i < $input.all().length; i++) {\n  const item = $input.all()[i];\n  const splitItem = splitItems[i]?.json || {};\n  const records = item.json?.result?.records || [];\n  const customerTrackCodes = splitItem.customerTrackCodes || [];\n  \n  // 砖 1: 专砖 专  FUND_ID\n  const latestByFundId = {};\n  for (const rec of records) {\n    const fundId = String(rec.FUND_ID);\n    if (!latestByFundId[fundId] || rec.REPORT_PERIOD > latestByFundId[fundId].REPORT_PERIOD) {\n      latestByFundId[fundId] = rec;\n    }\n  }\n  \n  // 砖 2: 转 专砖转  住 注 砖 砖驻\n  const allTracks = Object.values(latestByFundId).map(rec => {\n    const assets = parseFloat(rec.TOTAL_ASSETS || 1);\n    const exposure = parseFloat(rec.STOCK_MARKET_EXPOSURE || 0);\n    return {\n      fundId: String(rec.FUND_ID),\n      fundName: rec.FUND_NAME || '',\n      ytdYield: parseFloat(rec.YEAR_TO_DATE_YIELD || 0),\n      yield3Y: parseFloat(rec.AVG_ANNUAL_YIELD_TRAILING_3YRS || 0),\n      stockExposure: assets > 0 ? (exposure / assets) * 100 : 0,\n      totalAssets: assets,\n      managingCorp: rec.MANAGING_CORPORATION || '',\n      fundClassification: rec.FUND_CLASSIFICATION || '',\n      mgmtFee: parseFloat(rec.AVG_ANNUAL_MANAGEMENT_FEE || 0)\n    };\n  });\n  \n  // 砖 3:  驻 转砖 ( )\n  allTracks.sort((a, b) => b.ytdYield - a.ytdYield);\n  \n  // 砖 4: Top 3\n  const top3 = allTracks.slice(0, 3).map((t, idx) => ({\n    ...t,\n    rank: idx + 1\n  }));\n  \n  // 砖 5: 专转 专砖  住 砖 拽\n  for (const trackCode of customerTrackCodes) {\n    const customerTrack = allTracks.find(t => t.fundId === trackCode);\n    \n    // 砖 专 拽 拽转 转专\n    // 砖 专 住\n    const rankIndex = allTracks.findIndex(t => t.fundId === trackCode);\n    const ranking = rankIndex >= 0 ? rankIndex + 1 : null;\n    \n    // 拽转 专: 专拽   -TOP 3 + 砖驻  (卤15%) + 转砖  -7%+\n    let hasAlert = false;\n    let betterTrack = null;\n    \n    if (customerTrack && ranking > 3) {\n      for (const track of allTracks) {\n        if (track.fundId === trackCode) continue;\n        const exposureDiff = Math.abs(track.stockExposure - customerTrack.stockExposure);\n        const yieldDiff = track.ytdYield - customerTrack.ytdYield;\n        \n        if (exposureDiff <= 15 && yieldDiff >= 7) {\n          hasAlert = true;\n          betterTrack = track;\n          break;\n        }\n      }\n    }\n    \n    \n    \n    results.push({\n      json: {\n        trackCode,\n        trackName: customerTrack?.fundName || splitItem.trackName || '',\n        productTypeCode: splitItem.productTypeCode,\n        companyId: splitItem.companyId,\n        companyName: splitItem.companyName,\n        // 转 住 \n        stockExposure: customerTrack?.stockExposure || null,\n        ytdYield: customerTrack?.ytdYield || null,\n        yield3Y: customerTrack?.yield3Y || null,\n        totalAssets: customerTrack?.totalAssets || null,\n        managingCorp: customerTrack?.managingCorp || '',\n        fundClassification: customerTrack?.fundClassification || '',\n        mgmtFee: customerTrack?.mgmtFee || null,\n        // 爪转\n        ranking,\n        totalTracks: allTracks.length,\n        top3,\n        allTracks,\n        hasAlert,\n        betterTrack,\n        // \n        source: 'PENSIANET',\n        hasData: customerTrack !== undefined\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "f839c855-2d79-4a43-bf56-92efa726c9a8",
      "name": "Parse Pension Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32672,
        30720
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE BITUACH RESULTS - with name fallback =====\nconst results = [];\nconst splitItems = $('Split Bituach Tracks').all();\n\nfunction normalizeTrackName(name) {\n  if (!name) return '';\n  return name.trim().toLowerCase()\n    .replace(/[\\s-]+/g, ' ')\n    .replace(/注\\\"/g, '')\n    .replace(/\\./g, '')\n    .trim();\n}\n\nfor (let i = 0; i < $input.all().length; i++) {\n  const item = $input.all()[i];\n  const splitItem = splitItems[i]?.json || {};\n  const records = item.json?.result?.records || [];\n  const trackCode = splitItem.trackCode;\n  const trackName = splitItem.trackName;\n  const productTypeCode = splitItem.productTypeCode;\n  const searchByName = splitItem.searchByName || false;\n  \n  let rec = null;\n  \n  if (searchByName && trackName) {\n    // Search by name - find best match\n    const normalizedSearch = normalizeTrackName(trackName);\n    \n    // Build map of latest records by FUND_ID\n    const latestByFundId = {};\n    for (const r of records) {\n      const fundId = String(r.FUND_ID);\n      if (!latestByFundId[fundId] || r.REPORT_PERIOD > latestByFundId[fundId].REPORT_PERIOD) {\n        latestByFundId[fundId] = r;\n      }\n    }\n    \n    // Find matching record by name\n    for (const r of Object.values(latestByFundId)) {\n      const normalizedFundName = normalizeTrackName(r.FUND_NAME);\n      if (normalizedFundName.includes(normalizedSearch) || normalizedSearch.includes(normalizedFundName)) {\n        rec = r;\n        break;\n      }\n    }\n  } else {\n    // Direct FUND_ID lookup (limit=1)\n    rec = records[0];\n  }\n  \n  if (rec) {\n    const assets = parseFloat(rec.TOTAL_ASSETS || 1);\n    const exposure = parseFloat(rec.STOCK_MARKET_EXPOSURE || 0);\n    const parentCompanyLegalId = rec.PARENT_COMPANY_LEGAL_ID || null;\n    const fundClassification = rec.FUND_CLASSIFICATION || '';\n    \n    results.push({\n      json: {\n        trackCode: trackCode || rec.FUND_ID,\n        trackName: rec.FUND_NAME || trackName || '',\n        productTypeCode,\n        companyId: splitItem.companyIdNumber,\n        companyName: splitItem.companyName || rec.PARENT_COMPANY_NAME || '',\n        parentCompanyLegalId,\n        stockExposure: assets > 0 ? (exposure / assets) * 100 : 0,\n        ytdYield: parseFloat(rec.YEAR_TO_DATE_YIELD || 0),\n        yield3Y: parseFloat(rec.AVG_ANNUAL_YIELD_TRAILING_3YRS || 0),\n        totalAssets: assets,\n        managingCorp: rec.PARENT_COMPANY_NAME || '',\n        fundClassification,\n        mgmtFee: parseFloat(rec.AVG_ANNUAL_MANAGEMENT_FEE || 0),\n        source: 'BITUACHNET',\n        hasData: true,\n        foundByName: searchByName\n      }\n    });\n  } else {\n    results.push({\n      json: {\n        trackCode,\n        trackName: trackName || '',\n        productTypeCode,\n        companyId: splitItem.companyIdNumber,\n        companyName: splitItem.companyName,\n        parentCompanyLegalId: null,\n        stockExposure: null,\n        ytdYield: null,\n        yield3Y: null,\n        totalAssets: null,\n        managingCorp: '',\n        fundClassification: '',\n        mgmtFee: null,\n        source: 'BITUACHNET',\n        hasData: false,\n        foundByName: false\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "a55efd38-8700-45bd-a03f-fa7074c8492a",
      "name": "Parse Bituach Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32672,
        30912
      ]
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "id": "62695fdb-314b-4937-9844-b804f61703dc",
      "name": "Merge Market Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        32896,
        30624
      ]
    },
    {
      "parameters": {
        "jsCode": " const portfolioData = $('Parse Portfolio + Alerts').first().json;       \n  const marketDataInputs = $('Merge Market Data').all();\n\n  const PRODUCT_CODES = portfolioData.productCodes || {\n    PENSION: [1, 2, 19],\n    GEMEL: [3, 5, 6],\n    GEMEL_INVEST: [4],\n    HISHTALMUT: [7],\n    SAVINGS: [41],\n    INSURANCE: [8, 13, 14, 15]\n  };\n\n  const APPROVED_COMPANIES = [\n    '  驻住 注\"',\n    '住 拽驻转  注\"',\n    '专  驻住 注\"',\n    ' 拽驻转 拽专转 驻住 拽驻转  注\"',\n    '专 驻住  注\"',\n    '驻拽住 驻住  注\"',\n    '砖专 砖  驻住 注\"'\n  ];\n\n  const mergedData = marketDataInputs.map(item => item.json);\n  const BLACKLIST = portfolioData.blacklist || [];\n  const MIN_YIELD_GAP_FOR_ALERT = 7;\n\n  const analyzed = [];\n  const recommendations = [];\n\n  function isApprovedCompany(companyName) {\n    if (!companyName) return false;\n    return APPROVED_COMPANIES.some(approved =>\n      companyName.includes(approved) || approved.includes(companyName)    \n    );\n  }\n\n  function isInBlacklist(companyName) {\n    if (!companyName) return false;\n    return BLACKLIST.some(b => companyName.includes(b));\n  }\n\n  function getProductCategory(code) {\n    const numCode = Number(code);\n    if (PRODUCT_CODES.PENSION.includes(numCode)) return 'pension';\n    if (PRODUCT_CODES.GEMEL.includes(numCode)) return 'gemel';\n    if (PRODUCT_CODES.GEMEL_INVEST.includes(numCode)) return 'gemel_invest'; \n    if (PRODUCT_CODES.HISHTALMUT.includes(numCode)) return 'hishtalmut';     \n    if (PRODUCT_CODES.SAVINGS.includes(numCode)) return 'savings';\n    if (PRODUCT_CODES.INSURANCE.includes(numCode)) return 'insurance';       \n    return 'other';\n  }\n\n  for (const customerTrack of portfolioData.portfolioItems) {\n    const trackCode = customerTrack.trackCode;\n    const productTypeCode = customerTrack.productTypeCode;\n    const productCategory = getProductCategory(productTypeCode);\n\n    const marketTrack = mergedData.find(m => String(m.trackCode) === String(trackCode));\n\n    if (!marketTrack || !marketTrack.hasData) {\n      analyzed.push({\n        ...customerTrack,\n        stockExposure: null,\n        marketData: null,\n        ranking: null,\n        top3SameCompany: [],\n        hasAlert: false,\n        alertGap: 0,\n        status: 'NO_MARKET_DATA',\n        statusMessage: ' 转 砖拽  住 '\n      });\n      continue;\n    }\n\n    const marketYtdYield = parseFloat(marketTrack.ytdYield || 0);\n    const return3Y = parseFloat(marketTrack.yield3Y || 0);\n    const fundClassification = marketTrack.fundClassification || '';      \n    const managingCorp = marketTrack.managingCorp || customerTrack.companyName || '';\n    const mgmtFee = parseFloat(customerTrack.accumulationFee || 0);       \n    const totalAssets = parseFloat(marketTrack.totalAssets || 0);\n    const stockExposure = marketTrack.stockExposure;\n\n    // ========== 砖砖 -Top 3 砖注 -API ==========\n    const top3SameCompany = marketTrack.allTracks || marketTrack.top3 || [];\n\n    // 砖 专 转专转 转 -top3\n    const bestInCompany = top3SameCompany[0];\n    const gap = bestInCompany ? (bestInCompany.ytdYield - marketYtdYield) : 0;\n\n    const currentRankIndex = top3SameCompany.findIndex(m => String(m.fundId) === String(trackCode));\n    const isInTop3 = currentRankIndex >= 0 && currentRankIndex < 3;\n\n    // 转专 专拽 : 驻注专 >= 7%, 住  砖 , 住  -Top 3\n    const hasAlert = gap >= MIN_YIELD_GAP_FOR_ALERT && bestInCompany && String(bestInCompany.fundId) !== String(trackCode) && !isInTop3;\n\n    const currentRank = marketTrack.ranking || (currentRankIndex >= 0 ? currentRankIndex + 1 : null);\n    const totalInCategory = marketTrack.totalTracks || top3SameCompany.length;\n\n    const categoryAvg = top3SameCompany.length > 0\n      ? top3SameCompany.reduce((sum, m) => sum + m.ytdYield, 0) / top3SameCompany.length\n      : 0;\n    const diffFromAvg = marketYtdYield - categoryAvg;\n\n    let status = 'OK';\n    let statusMessage = '';\n\n    if (currentRank && totalInCategory > 0) {\n      const percentile = (currentRank / totalInCategory) * 100;\n      if (percentile <= 25) {\n        status = 'EXCELLENT';\n        statusMessage = '住 砖 专注 注!';\n      } else if (percentile <= 50) {\n        status = 'GOOD';\n        statusMessage = '住 砖 注 爪注';\n      } else if (percentile <= 75) {\n        status = 'BELOW_AVG';\n        statusMessage = '住 砖 转转 爪注';\n      } else {\n        status = 'POOR';\n        statusMessage = '住 砖 专注 转转';\n      }\n    }\n\n    analyzed.push({\n      ...customerTrack,\n      companyName: customerTrack.companyName || managingCorp,\n      stockExposure: stockExposure,\n      exposurePercent: stockExposure,\n      marketData: {\n        fundId: marketTrack.trackCode,\n        fundName: marketTrack.fundName || '',\n        company: managingCorp,\n        classification: fundClassification,\n        ytdYield: marketYtdYield,\n        return3Y: return3Y,\n        exposure: stockExposure,\n        mgmtFee: mgmtFee,\n        assets: totalAssets\n      },\n      ranking: {\n        position: currentRank,\n        total: totalInCategory,\n        categoryAvg: categoryAvg,\n        diffFromAvg: diffFromAvg,\n        percentile: currentRank && totalInCategory ? Math.round((currentRank / totalInCategory) * 100) : null\n      },\n      top3SameCompany: top3SameCompany,\n      hasAlert: hasAlert,\n      alertGap: gap,\n      bestAlternative: hasAlert ? bestInCompany : null,\n      status: status,\n      statusMessage: statusMessage\n    });\n\n    if (hasAlert && bestInCompany) {\n      const better = marketTrack.betterTrack || bestInCompany;\n      recommendations.push({\n        forTrack: customerTrack.trackName,\n        forTrackCode: trackCode,\n        productType: customerTrack.productType,\n        productTypeCode: productTypeCode,\n        productCategory: productCategory,\n        accumulation: customerTrack.trackAccumulation,\n        currentYtdYield: marketYtdYield,\n        currentReturn3Y: return3Y,\n        currentExposure: stockExposure,\n        currentMgmtFee: mgmtFee,\n        company: managingCorp,\n        gap: gap,\n        bestAlternative: {\n          fundName: better.fundName,\n          ytdYield: better.ytdYield,\n          exposure: better.stockExposure || better.exposure\n        },\n        ranking: currentRank,\n        totalInCategory: totalInCategory,\n        status: status,\n        message: '驻注专 砖 ' + gap.toFixed(1) + '% 住  转专'      \n      });\n    }\n  }\n\n  return {\n    json: {\n      customerInfo: portfolioData.customerInfo,\n      summaryStats: portfolioData.summaryStats,\n      criticalAlerts: portfolioData.criticalAlerts,\n      analyzedTracks: analyzed,\n      recommendations: recommendations,\n      productCodes: PRODUCT_CODES,\n      originalProducts: portfolioData.originalProducts || [],\n      stats: {\n        totalTracks: analyzed.length,\n        tracksWithAlert: analyzed.filter(t => t.hasAlert).length,\n        tracksWithMarketData: analyzed.filter(t => t.marketData !== null).length,\n        excellentTracks: analyzed.filter(t => t.status === 'EXCELLENT').length,\n        poorTracks: analyzed.filter(t => t.status === 'POOR' || t.status === 'BELOW_AVG').length\n      }\n    }\n  };"
      },
      "id": "f4d89485-5df1-4487-be9b-5508ea954152",
      "name": "Analyze Performance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33120,
        30624
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== OFFICIAL CLIENT REPORT - Updated Design =====\n// With proper category names and exposure calculations\nconst data = $input.first().json;\n\n// Build mutavim map from original products\nconst mutavimMap = {};\nconst originalProducts = data.originalProducts || [];\noriginalProducts.forEach(p => {\n    const key = p.accountPolicyNumber || p.productNumber;\n    if (key && p.mutavim && p.mutavim.length > 0) {\n        mutavimMap[key] = p.mutavim;\n    }\n});\nconst PRODUCT_CODES = data.productCodes || { PENSION: [1,2,19], GEMEL: [3,5,6], GEMEL_INVEST: [4], HISHTALMUT: [7], SAVINGS: [41], INSURANCE: [8,13,14,15] };\n\n// --- RECOMMENDATION CONFIG ---\nconst YIELD_MARGIN_THRESHOLD = 7.0;\nconst EXPOSURE_DIFF_THRESHOLD = 5;\nconst HIGH_RISK_THRESHOLD = 80;\nconst HIGH_EXPOSURE_THRESHOLD = 70;\n\n// --- COMPANY URLs MAP ---\nconst COMPANY_URLS = {\n    '驻拽住': 'https://my.fnx.co.il/',\n    '驻拽住': 'https://my.fnx.co.il/',\n    '': 'https://customers.meitav.co.il/v2/login/loginAmit',\n    '': 'https://www.clal.co.il/clal-online/login',\n    '专': 'https://www.more.co.il/personal-area/',\n    '砖专': 'https://www.as-invest.co.il/personal-area/',\n    '专': 'https://www.harel-group.co.il/my-harel/pages/login.aspx',\n    '': 'https://www.migdal.co.il/migdal-online',\n    '专': 'https://www.menoramivt.co.il/customer-service/online-services/',\n    '住': 'https://amitim.analyst.co.il/auth/login?redirectUrl=%2Flobby',\n    '': 'https://www.yl-invest.co.il/personal-area/',\n    '砖专': 'https://customers.hcsra.co.il/#/login?returnUrl=%2Fhome',\n    '': 'https://clientportfolio.ayalon-ins.co.il/cpLogin/mainLogin/login'\n};\n\nfunction formatCurrency(num) {\n    return new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(num || 0);\n}\n\nfunction formatPercent(num) {\n    if (num === null || num === undefined || isNaN(num)) return '-';\n    return num.toFixed(1) + '%';\n}\n\n// UPDATED: New category names\nfunction getProductCategory(code) {\n    const numCode = Number(code);\n    if (PRODUCT_CODES.PENSION.includes(numCode)) return '驻住';\n    if (PRODUCT_CODES.GEMEL.includes(numCode)) return '';\n    if (PRODUCT_CODES.INSURANCE.includes(numCode)) return '';\n    if (PRODUCT_CODES.HISHTALMUT.includes(numCode)) return '砖转转';\n    if (PRODUCT_CODES.GEMEL_INVEST.includes(numCode)) return '砖拽注转 专转';\n    if (PRODUCT_CODES.SAVINGS.includes(numCode)) return '砖拽注转 专转';\n    return '专';\n}\n\n// Category icon SVGs\nfunction getCategoryIcon(catName) {\n    const icons = {\n        '驻住': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M12 2L2 7l10 5 10-5-10-5z\"/><path d=\"M2 17l10 5 10-5\"/><path d=\"M2 12l10 5 10-5\"/></svg>',\n        '': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z\"/><path d=\"M2 9v1c0 1.1.9 2 2 2h1\"/></svg>',\n        '砖转转': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M22 10v6M2 10l10-5 10 5-10 5z\"/><path d=\"M6 12v5c0 2 2 3 6 3s6-1 6-3v-5\"/></svg>',\n        '砖拽注转 专转': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"8\"/><path d=\"M12 8v8\"/><path d=\"M8 12h8\"/></svg>',\n        '': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z\"/></svg>'\n    };\n    return icons[catName] || icons['砖拽注转 专转'];\n}\n\n// Category colors\nfunction getCategoryColor(catName) {\n    const colors = {\n        '驻住': 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)',\n        '': 'linear-gradient(135deg, #dc2626 0%, #f87171 100%)',\n        '砖转转': 'linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)',\n        '砖拽注转 专转': 'linear-gradient(135deg, #059669 0%, #34d399 100%)',\n        '': 'linear-gradient(135deg, #0891b2 0%, #22d3ee 100%)'\n    };\n    return colors[catName] || colors['砖拽注转 专转'];\n}\n\nfunction getCompanyLoginUrl(name) {\n    const n = name || '';\n    for (const [key, url] of Object.entries(COMPANY_URLS)) {\n        if (n.includes(key)) return url;\n    }\n    return '#';\n}\n\nfunction getFallbackColor(name) {\n    const n = name || '';\n    if (n.includes('驻拽住') || n.includes('驻拽住')) return '#f97316';\n    if (n.includes('')) return '#4f46e5';\n    if (n.includes('专')) return '#2563eb';\n    if (n.includes('')) return '#0d9488';\n    if (n.includes('')) return '#0891b2';\n    if (n.includes('砖专')) return '#16a34a';\n    if (n.includes('专')) return '#9333ea';\n    if (n.includes('住')) return '#0284c7';\n    if (n.includes('专')) return '#e11d48';\n    if (n.includes('')) return '#d97706';\n    return '#475569';\n}\n\nfunction cleanName(name, companyName) {\n    if (!name) return '';\n    let cleaned = name;\n    if (companyName) {\n        cleaned = cleaned.replace(new RegExp(companyName, 'gi'), '');\n        const companyFirstWord = companyName.split(' ')[0];\n        if (companyFirstWord) cleaned = cleaned.replace(new RegExp(companyFirstWord, 'gi'), '');\n    }\n    const stopWords = ['注\"', '-', '  '];\n    stopWords.forEach(word => { cleaned = cleaned.replace(new RegExp(word, 'g'), ' '); });\n    cleaned = cleaned.replace(/\\s+/g, ' ').trim();\n    return cleaned.length > 2 ? cleaned : name;\n}\n\nfunction calcEfficiency(ytd, exposure) {\n    if (!exposure || exposure === 0 || !ytd) return 0;\n    return ((ytd / exposure) * 10).toFixed(1);\n}\n\nfunction getStarRating(score) {\n    const s = parseFloat(score);\n    let stars = '';\n    for (let i = 1; i <= 5; i++) {\n        stars += i <= Math.round(s) ? '<span class=\"fill\"></span>' : '<span></span>';\n    }\n    return stars;\n}\n\nfunction getPensionSortPriority(productName) {\n    const name = (productName || '').toLowerCase();\n    if (name.includes('拽驻')) return 0;\n    if (name.includes('转') || name.includes('')) return 1;\n    return 2;\n}\n\nfunction processAlternatives(track, currentYtd, currentExposure, productTracks, ranking) {\n    const alternatives = track.top3SameCompany || [];\n    if (alternatives.length === 0) {\n        return { hasAlert: false, top3Alternatives: [] };\n    }\n\n    const currentId = String(track.trackCode || track.trackId || '');\n    const customerTrackIds = (productTracks || []).map(t => String(t.trackId));\n    const totalProductAccumulation = (productTracks || []).reduce((sum, t) => sum + (t.trackAccumulation || 0), 0);\n    const isHighExposure = currentExposure >= HIGH_EXPOSURE_THRESHOLD;\n\n    const filtered = alternatives\n        .filter(alt => String(alt.fundId) !== currentId)\n        .filter(alt => {\n            const altYield = alt.suaMithilatShanaCollection ?? alt.ytdYield ?? 0;\n            const altExposure = alt.ahuzHasifaMenayot ?? alt.stockExposure ?? alt.exposure ?? 0;\n            const yieldOk = altYield - currentYtd >= YIELD_MARGIN_THRESHOLD;\n            let exposureOk;\n            if (isHighExposure) {\n                exposureOk = altExposure >= HIGH_EXPOSURE_THRESHOLD;\n            } else {\n                exposureOk = Math.abs(altExposure - currentExposure) <= EXPOSURE_DIFF_THRESHOLD;\n            }\n            return yieldOk && exposureOk;\n        })\n        .map(alt => {\n            const altYield = alt.suaMithilatShanaCollection ?? alt.ytdYield ?? 0;\n            const altExposure = alt.ahuzHasifaMenayot ?? alt.stockExposure ?? alt.exposure ?? 0;\n            const efficiency = altExposure > 0 ? (altYield / altExposure) * 10 : 0;\n            const altId = String(alt.fundId);\n            const isOwned = customerTrackIds.includes(altId);\n            let ownedPercent = 0;\n            if (isOwned && totalProductAccumulation > 0) {\n                const ownedTrack = productTracks.find(t => String(t.trackId) === altId);\n                if (ownedTrack) {\n                    ownedPercent = ((ownedTrack.trackAccumulation || 0) / totalProductAccumulation * 100).toFixed(1);\n                }\n            }\n            return {\n                name: alt.fundName,\n                id: alt.fundId,\n                yield: altYield,\n                exposure: altExposure,\n                efficiency: efficiency,\n                isOwned: isOwned,\n                ownedPercent: ownedPercent,\n                isRecommended: true,\n                recommendReason: '爪'\n            };\n        })\n        .sort((a, b) => (b.efficiency || 0) - (a.efficiency || 0))\n        .slice(0, 3);\n\n    //  住 -TOP 3 -  转专\n    const isTop3 = ranking && ranking <= 3;\n    return {\n        hasAlert: !isTop3 && filtered.length > 0,\n        top3Alternatives: filtered\n    };\n}\n\n// UPDATED: New category structure\nconst portfolioData = {\n    '驻住': [],\n    '': [],\n    '': [],\n    '砖转转': [],\n    '砖拽注转 专转': []\n};\n\nconst categoryOrder = ['驻住', '', '', '砖转转', '砖拽注转 专转'];\n\n// FIXED:  专 = 拽爪转,  砖拽注 = \nconst honiCategories = ['砖转转', '砖拽注转 专转', ' 砖拽注'];\nconst kitzbaCategories = ['驻住', '', ''];\n\nconst productMap = {};\nfor (const track of data.analyzedTracks || []) {\n    const category = getProductCategory(track.productTypeCode);\n    const key = `${track.accountPolicyNumber || track.productNumber || track.productName}_${track.productTypeCode || 'unknown'}`;\n\n    if (!productMap[key]) {\n        productMap[key] = {\n            companyName: track.companyName || track.marketData?.company || '',\n            productName: track.shemTohnit || track.productName,\n            productNumber: track.accountPolicyNumber || track.productNumber,\n            productType: track.productType || category,\n            totalAccumulation: 0,\n            category: category,\n            criticalAlert: track.criticalAlert || null,\n            accumulationFee: track.accumulationFee || 0,\n            depositFee: track.depositFee || 0,\n            tracks: [],\n            mutavim: mutavimMap[track.accountPolicyNumber] || mutavimMap[track.productNumber] || []\n        };\n\n        // Add pension-specific data for pension products\n        if (category === '驻住' && (track.kitzbatNehut || track.insuredSalary || track.kitzbatZiknaKolelPremiot)) {\n            productMap[key].pensionData = {\n                insuredSalary: track.insuredSalary || 0,\n                kitzbatNehut: track.kitzbatNehut || 0,\n                kitzbaLeAlman: track.kitzbaLeAlman || 0,\n                kitzbaLeYetom: track.kitzbaLeYetom || 0,\n                lastDepositAmount: track.lastDepositAmount || 0,\n                lastDepositDate: track.lastDepositDate || '',\n                kitzbatZiknaKolelPremiot: track.kitzbatZiknaKolelPremiot || 0,\n                retirementAge: track.retirementAge || 67,\n                // Insurance coverage percentages (住 )\n                disabilityCoverage: track.disabilityCoverage || 0,\n                partnerCoverage: track.partnerCoverage || 0,\n                orphanCoverage: track.orphanCoverage || 0\n            };\n        }\n    }\n\n    const ytdYield = track.marketData?.ytdYield ?? track.ytdYield ?? track.suaMithilatShanaCollection ?? track.marketData?.suaMithilatShanaCollection ?? 0;\n    const return3Y = track.marketData?.return3Y ?? track.yield3Y ?? track.suaMitztaberet36H ?? track.marketData?.suaMitztaberet36H ?? null;\n    const stockExposure = track.stockExposure ?? track.exposurePercent ?? track.marketData?.exposure ?? track.marketData?.stockExposure ?? track.ahuzHasifaMenayot ?? 0;\n\n    productMap[key].tracks.push({\n        trackName: track.trackName,\n        trackId: track.trackCode || track.trackId || '',\n        trackAccumulation: track.trackAccumulation || 0,\n        fee: track.fee || track.managementFee || null,\n        marketData: {\n            ytdYield: ytdYield,\n            stockExposure: stockExposure,\n            exposure: stockExposure,\n            return3Y: return3Y\n        },\n        top3SameCompany: track.top3SameCompany || [],\n        ranking: track.ranking,\n        hasAlert: false,\n        top3Alternatives: []\n    });\n\n    productMap[key].totalAccumulation += track.trackAccumulation || 0;\n\n    if (track.criticalAlert && !productMap[key].criticalAlert) {\n        productMap[key].criticalAlert = track.criticalAlert;\n    }\n}\n\nfor (const key of Object.keys(productMap)) {\n    const product = productMap[key];\n    for (const trackItem of product.tracks) {\n        const { hasAlert, top3Alternatives } = processAlternatives(\n            { trackCode: trackItem.trackId, top3SameCompany: trackItem.top3SameCompany }, \n            trackItem.marketData.ytdYield, \n            trackItem.marketData.stockExposure, \n            product.tracks,\n            trackItem.ranking\n        );\n        trackItem.hasAlert = hasAlert;\n        trackItem.top3Alternatives = top3Alternatives;\n    }\n}\n\nfor (const product of Object.values(productMap)) {\n    if (portfolioData[product.category]) {\n        portfolioData[product.category].push(product);\n    }\n}\n\nif (portfolioData['驻住'] && portfolioData['驻住'].length > 0) {\n    portfolioData['驻住'].sort((a, b) => {\n        return getPensionSortPriority(a.productName) - getPensionSortPriority(b.productName);\n    });\n}\n\n// Calculate global stats\nlet grandTotal = 0, totalHoni = 0, totalKitzba = 0;\nlet weightedExpSum = 0, weightedYieldSum = 0;\nlet honiWeightedExp = 0, kitzbaWeightedExp = 0;\n\nfor (const [catName, products] of Object.entries(portfolioData)) {\n    for (const p of products) {\n        grandTotal += p.totalAccumulation;\n        for (const t of p.tracks) {\n            const acc = t.trackAccumulation || 0;\n            const exp = t.marketData?.stockExposure || 0;\n            const ytd = t.marketData?.ytdYield || 0;\n\n            weightedExpSum += acc * exp;\n            weightedYieldSum += acc * ytd;\n\n            if (honiCategories.includes(catName)) {\n                totalHoni += acc;\n                honiWeightedExp += acc * exp;\n            } else if (kitzbaCategories.includes(catName)) {\n                totalKitzba += acc;\n                kitzbaWeightedExp += acc * exp;\n            }\n        }\n    }\n}\n\nconst totalWeightedYield = grandTotal > 0 ? (weightedYieldSum / grandTotal) : 0;\nconst avgExpTotal = grandTotal > 0 ? (weightedExpSum / grandTotal) : 0;\nconst avgExpHoni = totalHoni > 0 ? (honiWeightedExp / totalHoni) : 0;\nconst avgExpKitzba = totalKitzba > 0 ? (kitzbaWeightedExp / totalKitzba) : 0;\n\nconst honiPercent = grandTotal > 0 ? (totalHoni / grandTotal) * 100 : 0;\nconst kitzbaPercent = grandTotal > 0 ? (totalKitzba / grandTotal) * 100 : 0;\n\n// Gauge calculations (circumference = 264 for r=42)\nconst gaugeCircumference = 264;\nconst gaugeExpOffset = gaugeCircumference - (avgExpTotal / 100) * gaugeCircumference;\nconst gaugeHoniOffset = gaugeCircumference - (avgExpHoni / 100) * gaugeCircumference;\nconst gaugeKitzbaOffset = gaugeCircumference - (avgExpKitzba / 100) * gaugeCircumference;\n\nconst portfolioJson = JSON.stringify(portfolioData);\n\nconst currentDate = new Date().toLocaleDateString('he-IL');\nconst hebrewMonths = ['专', '驻专专', '专抓', '驻专', '', '', '', '住', '住驻专', '拽专', '专', '爪专'];\nconst currentMonth = hebrewMonths[new Date().getMonth()] + ' ' + new Date().getFullYear();\nlet reportMonthDisplay = ' 转 砖 拽专 2025';\nconst customerName = data.customerName || data.customerInfo?.customerName || '拽';\nconst customerId = data.idNumber || data.customerInfo?.customerId || data.customerInfo?.idNumber || '000000000';\nconst firstName = customerName.split(' ')[0];\nconst customerAge = data.customerInfo?.age || null;\nconst marketTrendsText = data.marketTrendsText || ` 砖专 驻转转 转 2026 注爪: 转\"-125 注 4.7%, 转\"-90 拽 5.6%. 砖拽 转拽 -3.15 砖\". 拽 砖专 专 专转 -4% 注 转转 -3.5% 砖 拽专.\n\n吼 专\": S&P 500 注 1.6%, 住\"拽 1.9%. 砖拽 注 砖 注 50 祝 砖专转 爪专.\n\n 住专: 注 专转 专转 - \" 专 转 专 砖注转转.`;\n\n// Age-based exposure recommendation logic\nfunction getRecommendedExposure(age) {\n    if (!age) return {\n        min: 40, max: 60, label: '转',\n        description: '抓 转 转 砖驻转 转 ',\n        rule: ' 爪注: 100 驻转 '\n    };\n    if (age <= 40) return {\n        min: 60, max: 80, label: '爪',\n        description: ' 砖  专 转砖砖 专转 砖拽, 驻爪 转砖  砖 转 砖 爪专转 ',\n        rule: `驻  100 驻转 : ${100 - age}% 转`\n    };\n    if (age <= 50) return {\n        min: 50, max: 70, label: '爪 转',\n        description: '注 砖  转砖砖 转转 砖拽, 抓 砖专 注 砖驻  住转 转',\n        rule: `驻  100 驻转 : ${100 - age}% 转`\n    };\n    if (age <= 60) return {\n        min: 35, max: 45, label: '转',\n        description: ' 注 抓 转 驻转 住  专 住 \"',\n        rule: `驻  100 驻转 : ${100 - age}% 转`\n    };\n    return {\n        min: 15, max: 25, label: '砖专转',\n        description: '拽专转 驻专砖 专 注拽专转  砖专 注 注专 住祝 爪爪 驻住 驻爪',\n        rule: `抓 驻转 砖驻 转 -${100 - age}%  驻转`\n    };\n}\n\nconst recommendedExposure = getRecommendedExposure(customerAge);\n\n// Count total alerts (products with at least one alert)\nlet totalAlerts = 0;\ncategoryOrder.forEach(cat => {\n    if (portfolioData[cat]) {\n        portfolioData[cat].forEach(product => {\n            if (product.tracks) {\n                const hasProductAlert = product.tracks.some(track => \n                    track.hasAlert && track.top3Alternatives && track.top3Alternatives.length > 0\n                );\n                if (hasProductAlert) {\n                    totalAlerts++;\n                }\n            }\n        });\n    }\n});\n\n\n\n// Generate personalized exposure advice\nfunction getExposureAdvice(actualExposure, recommended, age) {\n    if (!age) return '';\n    const diff = actualExposure - recommended.max;\n    if (diff > 10) {\n        return `砖驻 转 砖 (${actualExposure.toFixed(0)}%)  抓 . 抓 砖拽 驻转转 砖驻 转.`;\n    } else if (diff < -15) {\n        return `砖驻 转 砖 (${actualExposure.toFixed(0)}%)  抓 . 转 砖转  转 驻爪 爪.`;\n    }\n    return `砖驻 转 砖 (${actualExposure.toFixed(0)}%) 转  驻专驻 住 抓.`;\n}\n\nconst exposureAdvice = getExposureAdvice(avgExpTotal, recommendedExposure, customerAge);\n\n// Calculate yields per category for chart\nconst categoryYields = {};\nfor (const [catName, products] of Object.entries(portfolioData)) {\n    if (products.length > 0) {\n        let totalAcc = 0, weightedYield = 0;\n        for (const p of products) {\n            for (const t of p.tracks) {\n                const acc = t.trackAccumulation || 0;\n                const ytd = t.marketData?.ytdYield || 0;\n                totalAcc += acc;\n                weightedYield += acc * ytd;\n            }\n        }\n        if (totalAcc > 0) {\n            categoryYields[catName] = (weightedYield / totalAcc).toFixed(1);\n        }\n    }\n}\n\n\n// Calculate exposures per category for chart\nconst categoryExposures = {};\nfor (const [catName, products] of Object.entries(portfolioData)) {\n    if (products.length > 0) {\n        let totalAcc = 0, weightedExposure = 0;\n        for (const p of products) {\n            for (const t of p.tracks) {\n                const acc = t.trackAccumulation || 0;\n                const exp = t.marketData?.stockExposure || 0;\n                totalAcc += acc;\n                weightedExposure += acc * exp;\n            }\n        }\n        if (totalAcc > 0) {\n            categoryExposures[catName] = (weightedExposure / totalAcc).toFixed(0);\n        }\n    }\n}\n\n// Calculate data by company (祝 )\nconst companyData = {};\nfor (const [catName, products] of Object.entries(portfolioData)) {\n    for (const p of products) {\n        const company = p.companyName || '专';\n        if (!companyData[company]) {\n            companyData[company] = {\n                name: company,\n                totalAcc: 0,\n                weightedYield: 0,\n                weightedExposure: 0,\n                honiAcc: 0,\n                honiExposure: 0,\n                kitzbaAcc: 0,\n                kitzbaExposure: 0,\n                products: []\n            };\n        }\n        \n        for (const t of p.tracks) {\n            const acc = t.trackAccumulation || 0;\n            const ytd = t.marketData?.ytdYield || 0;\n            const exp = t.marketData?.stockExposure || 0;\n            \n            companyData[company].totalAcc += acc;\n            companyData[company].weightedYield += acc * ytd;\n            companyData[company].weightedExposure += acc * exp;\n            \n            // Honi vs Kitzba\n            if (honiCategories.includes(catName)) {\n                companyData[company].honiAcc += acc;\n                companyData[company].honiExposure += acc * exp;\n            } else if (kitzbaCategories.includes(catName)) {\n                companyData[company].kitzbaAcc += acc;\n                companyData[company].kitzbaExposure += acc * exp;\n            }\n        }\n        \n        // Track products for yields chart\n        companyData[company].products.push({\n            category: catName,\n            name: p.productName,\n            yield: p.tracks.reduce((sum, t) => sum + (t.marketData?.ytdYield || 0), 0) / (p.tracks.length || 1)\n        });\n    }\n}\n\n// Finalize averages\nfor (const company of Object.values(companyData)) {\n    company.avgYield = company.totalAcc > 0 ? (company.weightedYield / company.totalAcc).toFixed(1) : 0;\n    company.avgExposure = company.totalAcc > 0 ? (company.weightedExposure / company.totalAcc).toFixed(0) : 0;\n    company.honiAvgExposure = company.honiAcc > 0 ? (company.honiExposure / company.honiAcc).toFixed(0) : 0;\n    company.kitzbaAvgExposure = company.kitzbaAcc > 0 ? (company.kitzbaExposure / company.kitzbaAcc).toFixed(0) : 0;\n}\n\n// Build yields by productType + company (aggregated)\nconst productTypeCompanyData = {};\nfor (const [catName, products] of Object.entries(portfolioData)) {\n    for (const p of products) {\n        const productType = p.productType || catName;\n        const company = p.companyName || '专';\n        const key = productType + ' - ' + company;\n        \n        if (!productTypeCompanyData[key]) {\n            productTypeCompanyData[key] = {\n                label: key,\n                productType: productType,\n                company: company,\n                totalAcc: 0,\n                weightedYield: 0\n            };\n        }\n        \n        for (const t of p.tracks) {\n            const acc = t.trackAccumulation || 0;\n            const ytd = t.marketData?.ytdYield || 0;\n            productTypeCompanyData[key].totalAcc += acc;\n            productTypeCompanyData[key].weightedYield += acc * ytd;\n        }\n    }\n}\n\n// Calculate average yields and build array\nconst productsForYields = [];\nfor (const item of Object.values(productTypeCompanyData)) {\n    if (item.totalAcc > 0) {\n        item.yield = parseFloat((item.weightedYield / item.totalAcc).toFixed(1));\n        item.accumulation = item.totalAcc;\n        productsForYields.push(item);\n    }\n}\n\n// Sort by accumulation (largest first) and take top 5\nproductsForYields.sort((a, b) => b.accumulation - a.accumulation);\nconst topProducts = productsForYields.slice(0, 5);\n\n\n\nconst html = `<!DOCTYPE html>\n<html dir=\"rtl\" lang=\"he\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>  注砖专 | ${customerName}</title>\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js\"></script>\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');\n\n        :root {\n            --bg-body: #f4f5f7;\n            --bg-card: #ffffff;\n            --bg-subtle: #f8fafc;\n            --text-main: #1e293b;\n            --text-secondary: #64748b;\n            --text-light: #94a3b8;\n            --brand-primary: #0f172a;\n            --brand-accent: #c29d59;\n            --positive: #059669;\n            --positive-bg: #ecfdf5;\n            --negative: #dc2626;\n            --warning: #d97706;\n            --color-pension: #1e3a8a;\n            --color-gemel: #3b82f6;\n            --color-hish: #94a3b8;\n            --border-light: #e2e8f0;\n            --border-medium: #cbd5e1;\n            --radius: 8px;\n            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);\n        }\n\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        html { scroll-behavior: smooth; }\n        body { font-family: 'Assistant', sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.6; padding-bottom: 80px; }\n        .container { margin: 0 auto; padding: 0 20px; }\n        .container-narrow { max-width: 900px; }\n        .container-wide { max-width: 1000px; }\n\n        /* Cover Page */\n        .cover-section { padding: 60px 0; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }\n        #detailed-report { display: none; }\n        #insurance-report-content { display: none; }\n        \n        .cover-header { text-align: center; margin-bottom: 60px; border-bottom: 2px solid var(--brand-accent); padding-bottom: 40px; }\n        .logo-icon { font-size: 32px; color: var(--brand-primary); margin-bottom: 16px; }\n        .cover-title { font-family: inherit; font-size: 42px; font-weight: 700; color: var(--brand-primary); margin-bottom: 8px; }\n        .cover-subtitle { font-size: 18px; color: var(--text-secondary); font-weight: 500; }\n        .date-badge { display: inline-block; background: var(--brand-primary); color: #fff; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-bottom: 20px; }\n\n        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 60px; }\n        .text-section h2 { font-size: 18px; color: var(--brand-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--brand-accent); }\n        .text-section p { font-size: 15px; color: var(--text-secondary); margin-bottom: 16px; }\n        .highlight-box { background: var(--positive-bg); border-right: 3px solid var(--positive); padding: 16px; border-radius: var(--radius); font-size: 14px; color: var(--text-main); }\n        .text-green { color: var(--positive); }\n\n        \n        .chart-tab-btn {\n            padding: 8px 16px;\n            border: 1px solid var(--border-light);\n            background: var(--bg-card);\n            color: var(--text-secondary);\n            border-radius: 20px;\n            font-family: inherit;\n            font-size: 13px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: all 0.2s;\n        }\n        .chart-tab-btn:hover {\n            background: var(--bg-subtle);\n            border-color: var(--brand-accent);\n        }\n        .chart-tab-btn.active {\n            background: var(--brand-primary);\n            color: #fff;\n            border-color: var(--brand-primary);\n        }\n\n        .chart-section { background: var(--bg-card); padding: 40px; border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }\n        .chart-header { text-align: center; margin-bottom: 30px; }\n        .chart-title { font-size: 18px; font-weight: 700; color: var(--brand-primary); }\n        .line-chart-container { padding: 0 10px; }\n        .line-chart { width: 100%; height: 220px; }\n        .chart-legend { display: flex; justify-content: center; gap: 24px; margin-top: 20px; flex-wrap: wrap; }\n        .chart-legend .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }\n        .chart-legend .legend-dot { width: 10px; height: 10px; border-radius: 50%; }\n        .chart-legend strong { color: var(--text-main); margin-right: 4px; }\n\n        .nav-buttons { display: flex; gap: 16px; justify-content: center; margin: 30px 0 40px 0; }\n        .nav-btn { \n            display: inline-flex;\n            align-items: center;\n            gap: 10px;\n            background: var(--brand-primary); \n            color: #fff;\n            border: none;\n            border-radius: 25px; \n            padding: 12px 28px; \n            font-size: 15px;\n            font-weight: 600;\n            font-family: inherit;\n            cursor: pointer; \n            transition: all 0.3s ease;\n            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2);\n        }\n        .nav-btn:hover { background: #1e40af; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }\n        .nav-btn.active { background: #1e40af; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.4); }\n        .nav-btn.secondary { background: #fff; color: var(--brand-primary); border: 2px solid var(--brand-primary); }\n        .nav-btn.secondary:hover { background: var(--bg-subtle); }\n        .nav-btn i { font-size: 16px; }\n\n        /* Report Page */\n        .header-card { background: var(--brand-primary); padding: 24px 0; margin-bottom: 32px; border-radius: var(--radius); }\n        .header-content { display: flex; justify-content: space-between; align-items: center; }\n        .brand { display: flex; align-items: center; gap: 12px; }\n        .brand-icon-box { width: 48px; height: 48px; border-radius: 12px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; }\n        .brand-text h1 { color: #fff; font-size: 22px; font-weight: 700; }\n        .brand-text p { color: rgba(255,255,255,0.7); font-size: 13px; }\n        .client-info-box { text-align: left; }\n        .client-name-lg { color: #fff; font-size: 18px; font-weight: 700; }\n        .report-date-sm { color: rgba(255,255,255,0.7); font-size: 12px; }\n\n        /* Dashboard Summary */\n        .dashboard-summary { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-sm); margin-bottom: 32px; overflow: hidden; }\n        .summary-header { background: linear-gradient(135deg, var(--brand-primary) 0%, #1e40af 100%); padding: 28px 32px; text-align: center; }\n        .total-label { font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }\n        .total-amount { font-size: 36px; font-weight: 700; color: #fff; letter-spacing: -1px; }\n        .total-sub { font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 8px; }\n        .total-sub .text-green { color: #4ade80; font-weight: 600; }\n        .gauges-row { display: flex; justify-content: space-around; padding: 28px 20px; background: var(--bg-card); }\n        .gauge-item { display: flex; flex-direction: column; align-items: center; text-align: center; flex: 1; }\n        .gauge-item .gauge-wrapper { position: relative; width: 100px; height: 100px; margin-bottom: 12px; }\n        .gauge-item .gauge-svg { width: 100%; height: 100%; transform: rotate(-90deg); }\n        .gauge-item .gauge-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: 700; color: var(--brand-primary); }\n        .gauge-item .gauge-label { font-size: 13px; font-weight: 600; color: var(--text-main); margin-bottom: 4px; }\n        .gauge-item .gauge-sub { font-size: 12px; color: var(--text-secondary); }\n        .gauge-bg { fill: none; stroke: var(--bg-subtle); stroke-width: 8; }\n        .gauge-fill { fill: none; stroke-width: 8; stroke-linecap: round; stroke-dasharray: 264; transition: stroke-dashoffset 1s ease-out; }\n\n        .holdings-container { display: flex; flex-direction: column; gap: 16px; }\n        .category-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; border: 1px solid var(--border-light); }\n        .category-header { padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: linear-gradient(to left, #fff, #f8fafc); transition: background 0.2s; }\n        .category-header:hover { background: #f1f5f9; }\n        .cat-main { display: flex; align-items: center; gap: 16px; }\n        .cat-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); }\n        .cat-title h3 { font-size: 16px; font-weight: 700; color: var(--brand-primary); }\n        .cat-meta { font-size: 13px; color: var(--text-secondary); }\n        .cat-stats { text-align: left; display: flex; flex-direction: column; align-items: flex-end; }\n        .amount { font-weight: 700; color: var(--brand-primary); font-size: 16px; }\n        .yield { font-size: 13px; font-weight: 600; background: var(--positive-bg); color: var(--positive); padding: 2px 8px; border-radius: 12px; margin-top: 4px; }\n\n        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: var(--bg-subtle); }\n        .accordion-body.open { max-height: 3000px; }\n        .chevron { color: var(--text-light); transition: transform 0.3s; font-size: 10px; margin-right: 12px; display: inline-block; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid var(--text-secondary); }\n        .chevron::before { content: none !important; }\n        .chevron.open { transform: rotate(180deg); }\n\n        /* Products Header */\n        .products-header {\n            display: grid;\n            grid-template-columns: 2fr 1fr 1fr 0.8fr 0.8fr 0.8fr 40px;\n            gap: 8px;\n            padding: 10px 24px;\n            background: var(--bg-subtle);\n            border-bottom: 2px solid var(--border-light);\n            font-size: 11px;\n            font-weight: 600;\n            color: var(--text-secondary);\n            text-transform: uppercase;\n        }\n        .ph-name { text-align: right; }\n        .ph-number, .ph-accumulation, .ph-fee, .ph-yield { text-align: center; }\n\n        /* Product Row - Grid Layout */\n        .product-row {\n            display: grid;\n            grid-template-columns: 2fr 1fr 1fr 0.8fr 0.8fr 0.8fr 40px;\n            gap: 8px;\n            padding: 14px 24px;\n            align-items: center;\n            border-bottom: 1px solid var(--border-light);\n            background: var(--bg-card);\n            cursor: pointer;\n        }\n        .product-row:hover { background: var(--bg-subtle); }\n        .product-info { display: flex; align-items: center; gap: 10px; }\n        .company-logo { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; font-weight: 700; flex-shrink: 0; }\n        .product-name { font-weight: 600; color: var(--text-main); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n        .product-number { text-align: center; font-size: 12px; color: var(--text-light); }\n        .product-accumulation { text-align: center; font-weight: 700; color: var(--brand-primary); font-size: 14px; }\n        .product-fee { text-align: center; font-size: 12px; color: var(--text-secondary); }\n        .product-yield { text-align: center; font-size: 13px; font-weight: 600; }\n\n        .track-container { padding: 16px 24px; }\n        .track-row { display: flex; align-items: center; padding: 12px 16px; background: #fff; border: 1px solid var(--border-light); border-radius: var(--radius); margin-bottom: 8px; cursor: pointer; }\n        .track-title { flex: 1; }\n        .track-row:hover { border-color: var(--brand-primary); }\n        .track-row.has-alert { border-right: 3px solid var(--warning); }\n        .alert-icon { color: var(--warning); margin-left: 8px; font-size: 14px; animation: pulse 2s infinite; }\n        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }\n        .track-title h5 { font-size: 14px; font-weight: 600; color: var(--text-main); }\n        .track-sub { font-size: 12px; color: var(--text-secondary); }\n        .mini-stat { text-align: center; padding: 0 16px; min-width: 80px; }\n        .mini-val { font-weight: 700; font-size: 14px; }\n        .mini-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; }\n        \n        .exposure-stat { min-width: 90px; }\n        .exposure-bar-wrapper { width: 70px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 0 auto 4px auto; }\n        .exposure-bar { height: 100%; border-radius: 4px; transition: width 0.3s ease; }\n        .exposure-bar.low { background: linear-gradient(90deg, #10b981, #34d399); }\n        .exposure-bar.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }\n        .exposure-bar.high { background: linear-gradient(90deg, #ef4444, #f87171); }\n\n        .track-details { padding: 16px; background: #f8fafc; border-radius: var(--radius); margin-top: 8px; }\n        .metrics-strip { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }\n        .metric-box { background: #fff; padding: 12px 16px; border-radius: 6px; border: 1px solid var(--border-light); flex: 1; min-width: 120px; }\n        .metric-box .label { font-size: 10px; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; }\n        .metric-box .val { font-size: 16px; font-weight: 700; color: var(--brand-primary); }\n\n        .efficiency-dots { display: flex; gap: 3px; }\n        .efficiency-dots span { font-size: 12px; color: var(--border-light); }\n        .efficiency-dots span::before { content: ''; }\n        .efficiency-dots span.fill { color: var(--brand-accent); }\n\n        .alt-table-wrapper { background: #fff; border: 1px solid var(--border-light); border-radius: var(--radius); overflow: hidden; }\n        .alt-table-header { background: var(--bg-subtle); padding: 10px 16px; font-size: 12px; font-weight: 700; color: var(--brand-primary); border-bottom: 1px solid var(--border-light); }\n        .alt-table { width: 100%; border-collapse: collapse; font-size: 13px; }\n        .alt-table th { background: var(--bg-subtle); padding: 10px 12px; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; }\n        .alt-table td { padding: 12px; border-bottom: 1px solid var(--border-light); }\n        .alt-table tr:last-child td { border-bottom: none; }\n        .badge-rec { display: inline-block; background: var(--positive-bg); color: var(--positive); font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-right: 6px; }\n\n        /* Pension Coverage Box - Icon Cards Design */\n        .pension-coverage-box {\n            display: grid;\n            grid-template-columns: repeat(2, 1fr);\n            gap: 12px;\n            margin: 16px;\n        }\n        .coverage-card {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            padding: 14px 16px;\n            border-radius: 12px;\n            background: #fff;\n            border: 1px solid var(--border-light);\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n        .coverage-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.08);\n        }\n        .coverage-icon {\n            width: 48px;\n            height: 48px;\n            border-radius: 12px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            flex-shrink: 0;\n        }\n        .salary-card .coverage-icon { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8; }\n        .disability-card .coverage-icon { background: linear-gradient(135deg, #fce7f3, #fbcfe8); color: #be185d; }\n        .survivors-card .coverage-icon { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }\n        .deposit-card .coverage-icon { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669; }\n        .coverage-content {\n            flex: 1;\n            min-width: 0;\n        }\n        .coverage-label {\n            font-size: 11px;\n            color: var(--text-secondary);\n            margin-bottom: 2px;\n            font-weight: 500;\n        }\n        .coverage-value {\n            font-size: 18px;\n            font-weight: 800;\n            color: var(--text-main);\n            white-space: nowrap;\n        }\n        .coverage-value .unit {\n            font-size: 11px;\n            font-weight: 400;\n            color: var(--text-light);\n            margin-right: 2px;\n        }\n        .coverage-sub {\n            font-size: 10px;\n            color: var(--text-light);\n            margin-top: 2px;\n        }\n\n        /* Pension Projection Box */\n        .pension-projection-box {\n            display: flex;\n            align-items: center;\n            gap: 16px;\n            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);\n            border: 1px solid #fcd34d;\n            border-radius: 12px;\n            padding: 20px 24px;\n            margin: 16px;\n        }\n        .projection-icon {\n            width: 56px;\n            height: 56px;\n            border-radius: 50%;\n            background: #fbbf24;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: #78350f;\n            flex-shrink: 0;\n        }\n        .projection-content {\n            flex: 1;\n        }\n        .projection-text {\n            font-size: 14px;\n            color: #78350f;\n            line-height: 1.6;\n        }\n        .projection-amount {\n            font-size: 28px;\n            font-weight: 800;\n            color: #92400e;\n            margin-top: 8px;\n        }\n        .projection-amount span {\n            font-size: 14px;\n            font-weight: 400;\n            color: #a16207;\n        }\n        .projection-couple {\n            color: #b45309;\n            opacity: 0.6;\n            flex-shrink: 0;\n        }\n\n        /* Pension Book Icon */\n        .pension-book-icon {\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            width: 24px;\n            height: 24px;\n            border-radius: 6px;\n            background: linear-gradient(135deg, #dbeafe, #bfdbfe);\n            color: #1d4ed8;\n            cursor: pointer;\n            transition: all 0.2s;\n            margin-right: 8px;\n            flex-shrink: 0;\n        }\n        .pension-book-icon:hover {\n            background: linear-gradient(135deg, #bfdbfe, #93c5fd);\n            transform: scale(1.1);\n        }\n        /* Mutavim Icon Button */\n        .mutavim-icon-btn {\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            width: 24px;\n            height: 24px;\n            border-radius: 6px;\n            background: linear-gradient(135deg, #fef3c7, #fde68a);\n            color: #92400e;\n            cursor: pointer;\n            transition: all 0.2s;\n            margin-right: 8px;\n            flex-shrink: 0;\n            position: relative;\n            border: 1px solid #f59e0b;\n        }\n        .mutavim-icon-btn:hover {\n            background: linear-gradient(135deg, #fde68a, #fbbf24);\n            transform: scale(1.1);\n        }\n        .mutavim-icon-btn:hover::after {\n            content: '爪驻 ';\n            position: absolute;\n            top: -32px;\n            right: 50%;\n            transform: translateX(50%);\n            background: #1f2937;\n            color: #fff;\n            padding: 6px 10px;\n            border-radius: 6px;\n            font-size: 11px;\n            white-space: nowrap;\n            z-index: 100;\n        }\n        .mutavim-icon-btn:hover::before {\n            content: '';\n            position: absolute;\n            top: -8px;\n            right: 50%;\n            transform: translateX(50%);\n            border: 5px solid transparent;\n            border-top-color: #1f2937;\n            z-index: 100;\n        }\n\n        /* Mutavim Modal */\n        .mutavim-modal {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            z-index: 1000;\n            align-items: center;\n            justify-content: center;\n        }\n        .mutavim-modal.open {\n            display: flex;\n        }\n        .mutavim-modal-content {\n            background: #fff;\n            border-radius: 16px;\n            width: 90%;\n            max-width: 500px;\n            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);\n            overflow: hidden;\n        }\n        .mutavim-modal-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 20px 24px;\n            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);\n            color: #78350f;\n        }\n        .mutavim-modal-header h3 {\n            font-size: 18px;\n            font-weight: 700;\n            margin: 0;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n        .mutavim-modal-close {\n            background: rgba(255,255,255,0.3);\n            border: none;\n            color: #78350f;\n            width: 32px;\n            height: 32px;\n            border-radius: 8px;\n            font-size: 20px;\n            cursor: pointer;\n            transition: background 0.2s;\n        }\n        .mutavim-modal-close:hover {\n            background: rgba(255,255,255,0.5);\n        }\n        .mutavim-modal-body {\n            padding: 24px;\n            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);\n        }\n        .mutavim-modal-list {\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n        .mutavim-modal-item {\n            display: grid;\n            grid-template-columns: 1fr auto;\n            gap: 12px;\n            padding: 16px;\n            background: #fff;\n            border-radius: 12px;\n            border: 1px solid #fde68a;\n            box-shadow: 0 2px 8px rgba(245,158,11,0.1);\n        }\n        .mutavim-modal-name {\n            font-size: 16px;\n            font-weight: 700;\n            color: #1f2937;\n        }\n        .mutavim-modal-id {\n            font-size: 13px;\n            color: #6b7280;\n            margin-top: 4px;\n            font-family: monospace;\n        }\n        .mutavim-modal-percent {\n            font-size: 24px;\n            font-weight: 800;\n            color: #d97706;\n            display: flex;\n            align-items: center;\n        }\n\n\n        /* Pension Modal */\n        .pension-modal {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            z-index: 1000;\n            align-items: center;\n            justify-content: center;\n        }\n        .pension-modal.open {\n            display: flex;\n        }\n        .pension-modal-content {\n            background: #fff;\n            border-radius: 16px;\n            width: 90%;\n            max-width: 500px;\n            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);\n            overflow: hidden;\n        }\n        .modal-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 20px 24px;\n            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);\n            color: #fff;\n        }\n        .modal-header h3 {\n            font-size: 18px;\n            font-weight: 700;\n            margin: 0;\n        }\n        .modal-close {\n            background: rgba(255,255,255,0.2);\n            border: none;\n            color: #fff;\n            width: 32px;\n            height: 32px;\n            border-radius: 8px;\n            font-size: 20px;\n            cursor: pointer;\n            transition: background 0.2s;\n        }\n        .modal-close:hover {\n            background: rgba(255,255,255,0.3);\n        }\n        .modal-body {\n            padding: 24px;\n        }\n        .modal-grid {\n            display: grid;\n            grid-template-columns: repeat(2, 1fr);\n            gap: 16px;\n        }\n        .modal-item {\n            padding: 16px;\n            background: var(--bg-subtle);\n            border-radius: 12px;\n            text-align: center;\n        }\n        .modal-label {\n            font-size: 12px;\n            color: var(--text-secondary);\n            margin-bottom: 8px;\n        }\n        .modal-value {\n            font-size: 20px;\n            font-weight: 800;\n            color: var(--brand-primary);\n        }\n\n        /* Insurance Track Box */\n        .insurance-track-box {\n            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);\n            border: 1px solid #bfdbfe;\n            border-radius: 12px;\n            padding: 16px 20px;\n            margin-bottom: 20px;\n        }\n        .insurance-track-label {\n            font-size: 13px;\n            font-weight: 700;\n            color: #1e40af;\n            margin-bottom: 12px;\n        }\n        .insurance-track-items {\n            display: flex;\n            gap: 16px;\n            flex-wrap: wrap;\n        }\n        .insurance-track-item {\n            display: flex;\n            align-items: center;\n            gap: 6px;\n            background: #fff;\n            padding: 8px 14px;\n            border-radius: 20px;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        }\n        .track-percent {\n            font-size: 16px;\n            font-weight: 800;\n            color: #1d4ed8;\n        }\n        .track-type {\n            font-size: 12px;\n            color: #64748b;\n        }\n\n        .floating-footer { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #fff; padding: 10px 10px; border-radius: 50px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); display: flex; gap: 8px; z-index: 100; border: 1px solid var(--border-light); }\n        .btn { border: none; padding: 10px 24px; border-radius: 24px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }\n        .btn-ghost { background: transparent; color: var(--text-secondary); }\n        .btn-ghost:hover { background: var(--bg-subtle); color: var(--text-main); }\n        .btn-primary { background: var(--brand-primary); color: #fff; }\n        .btn-primary:hover { background: #020617; transform: translateY(-1px); }\n\n        /* ========== MOBILE RESPONSIVE ========== */\n        @media (max-width: 768px) {\n            /* Base */\n            body { padding: 0 8px; }\n            .container { padding: 0 12px; }\n            .container-narrow, .container-wide { max-width: 100%; padding: 0 12px; }\n\n            /* Cover Page */\n            .cover-section { padding: 30px 0; min-height: auto; }\n            .cover-header { margin-bottom: 30px; padding-bottom: 20px; }\n            .cover-title { font-size: 26px; }\n            .cover-subtitle { font-size: 14px; }\n            .content-grid { grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }\n            .text-section h2 { font-size: 16px; }\n            .text-section p { font-size: 13px; }\n            .highlight-box { font-size: 12px; padding: 12px; }\n\n            /* Chart */\n            .chart-section { padding: 16px 12px; }\n            .chart-title { font-size: 15px; }\n            .chart-legend { gap: 10px; }\n            .chart-legend .legend-item { font-size: 10px; }\n\n            /* Nav Buttons */\n            .nav-buttons { flex-direction: column; gap: 10px; margin: 20px 0 30px 0; }\n            .nav-btn { padding: 10px 20px; font-size: 14px; width: 100%; justify-content: center; }\n\n            /* Header Card */\n            .header-card { padding: 14px 0; margin-bottom: 16px; }\n            .header-content { flex-direction: column; gap: 12px; text-align: center; }\n            .brand-text h1 { font-size: 16px; }\n            .brand-icon-box { width: 36px; height: 36px; font-size: 16px; }\n            .client-info-box { text-align: center; }\n            .client-name-lg { font-size: 15px; }\n\n            /* Dashboard Summary */\n            .summary-header { padding: 18px 14px; }\n            .total-label { font-size: 10px; }\n            .total-amount { font-size: 24px; }\n            .total-sub { font-size: 12px; }\n            .gauges-row { flex-direction: column; gap: 20px; padding: 16px 10px; }\n            .gauge-item .gauge-wrapper { width: 70px; height: 70px; }\n            .gauge-item .gauge-value { font-size: 16px; }\n            .gauge-item .gauge-label { font-size: 11px; }\n            .gauge-item .gauge-sub { font-size: 10px; }\n\n            /* Category Cards */\n            .category-header { padding: 14px 12px; }\n            .cat-icon { width: 32px; height: 32px; font-size: 13px; border-radius: 8px; }\n            .cat-main { gap: 10px; }\n            .cat-title h3 { font-size: 13px; }\n            .cat-meta { font-size: 11px; }\n            .cat-stats { align-items: flex-end; }\n            .amount { font-size: 14px; }\n            .yield { font-size: 11px; padding: 2px 6px; }\n\n            /* Products Header - hide on mobile */\n            .products-header { display: none; }\n\n            /* Product Row - Mobile layout */\n            .product-row {\n                display: flex !important;\n                flex-direction: column !important;\n                padding: 12px !important;\n                gap: 6px !important;\n            }\n            .product-info {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                margin-bottom: 6px;\n            }\n            .product-name { font-size: 13px; flex: 1; }\n            .company-logo { width: 26px; height: 26px; font-size: 9px; }\n            .pension-book-icon { width: 20px; height: 20px; }\n\n            /* Product details row */\n            .product-policy, .product-accumulation, .product-fee, .product-yield {\n                font-size: 11px !important;\n            }\n            .product-row > div:not(.product-info):not(.chevron) {\n                display: inline-block;\n                margin-left: 12px;\n            }\n            .product-row > div:not(.product-info)::before {\n                font-size: 9px;\n                color: var(--text-light);\n                margin-left: 2px;\n            }\n            .product-accumulation::before { content: '爪专: '; }\n            .product-yield::before { content: '转砖: '; }\n            .product-fee::before { content: '状: '; }\n\n            \n        /* Mutavim (Beneficiaries) - Amber Frame */\n        .mutavim-section { margin: 16px 0 !important; padding: 16px !important; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; border-radius: 10px !important; border: 2px solid #f59e0b !important; box-shadow: 0 2px 8px rgba(245,158,11,0.15) !important; }\n        .mutavim-header { display: flex !important; align-items: center !important; gap: 10px !important; margin-bottom: 12px !important; padding-bottom: 10px !important; border-bottom: 1px solid rgba(146,64,14,0.2) !important; }\n        .mutavim-icon { font-size: 20px !important; }\n        .mutavim-title { font-size: 15px !important; font-weight: 700 !important; color: #92400e !important; }\n        .mutavim-list { display: flex !important; flex-direction: column !important; gap: 8px !important; }\n        .mutav-row { display: grid !important; grid-template-columns: 1fr 100px 140px 60px !important; gap: 12px !important; padding: 10px 14px !important; background: rgba(255,255,255,0.85) !important; border-radius: 8px !important; font-size: 13px !important; border: 1px solid rgba(251,191,36,0.3) !important; }\n        .mutav-name { font-weight: 600 !important; color: #1e293b !important; }\n        .mutav-relation { color: #64748b !important; }\n        .mutav-purpose { color: #78350f !important; font-size: 12px !important; }\n        .mutav-percent { font-weight: 700 !important; color: #92400e !important; text-align: left !important; }\n        @media (max-width: 768px) { .mutav-row { grid-template-columns: 1fr 1fr !important; } }\n\n        /* Track Row */\n            .track-row {\n                padding: 10px 12px !important;\n                flex-wrap: wrap;\n            }\n            .track-main {\n                width: 100%;\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 6px;\n            }\n            .track-info { font-size: 12px; }\n            .track-stats {\n                width: 100%;\n                justify-content: flex-start;\n                gap: 12px;\n                margin-top: 6px;\n                flex-wrap: wrap;\n            }\n            .stat-item { font-size: 10px; }\n            .stat-value { font-size: 12px; }\n\n            /* Recommendation Box */\n            .recommendation-box { padding: 10px; margin: 8px; }\n            .rec-header { font-size: 11px; gap: 6px; }\n            .alt-tracks-list { gap: 6px; }\n            .alt-track-item { padding: 8px 10px; font-size: 11px; }\n            .alt-yield { font-size: 10px; padding: 2px 6px; }\n\n            /* Floating Footer */\n            .floating-footer {\n                bottom: 8px;\n                padding: 6px 8px;\n                gap: 4px;\n                width: calc(100% - 16px);\n                max-width: none;\n                border-radius: 24px;\n            }\n            .btn { padding: 8px 14px; font-size: 11px; gap: 4px; }\n\n            /* Pension Modal */\n            .pension-modal-content { width: 95%; max-width: none; margin: 8px; }\n            .modal-header { padding: 14px 16px; }\n            .modal-header h3 { font-size: 15px; }\n            .modal-body { padding: 14px; }\n            .modal-grid { grid-template-columns: 1fr 1fr; gap: 10px; }\n            .modal-item { padding: 10px; }\n            .modal-label { font-size: 10px; }\n            .modal-value { font-size: 16px; }\n\n            /* Pension Projection Box */\n            .pension-projection-box {\n                flex-direction: column;\n                text-align: center;\n                padding: 14px;\n                gap: 10px;\n            }\n            .projection-icon { width: 44px; height: 44px; }\n            .projection-icon svg { width: 24px; height: 24px; }\n            .projection-text { font-size: 12px; }\n            .projection-amount { font-size: 22px; }\n            .projection-couple { display: none; }\n\n            /* Insurance Track Box */\n            .insurance-track-box { padding: 12px 14px; margin-bottom: 14px; }\n            .insurance-track-label { font-size: 12px; margin-bottom: 10px; }\n            .insurance-track-items { gap: 6px; }\n            .insurance-track-item { padding: 6px 10px; }\n            .track-percent { font-size: 13px; }\n            .track-type { font-size: 10px; }\n        }\n\n        /* Extra small devices (phones in portrait) */\n        @media (max-width: 480px) {\n            .cover-title { font-size: 22px; }\n            .total-amount { font-size: 20px; }\n            .pension-coverage-box { grid-template-columns: 1fr; }\n            .modal-grid { grid-template-columns: 1fr; }\n            .gauge-item .gauge-wrapper { width: 60px; height: 60px; }\n            .gauge-item .gauge-value { font-size: 14px; }\n            .product-name { font-size: 12px; }\n            .cat-title h3 { font-size: 12px; }\n            .amount { font-size: 13px; }\n            .insurance-track-items { flex-direction: column; }\n            .insurance-track-item { justify-content: center; }\n        }\n\n        @media print {\n            body { background: #fff; padding: 0; }\n            .floating-footer { display: none; }\n            .no-print { display: none; }\n            .cover-section { min-height: auto; padding: 40px 0; }\n            .accordion-body { max-height: none !important; }\n            .page-break { page-break-before: always; }\n        }\n    \n        /* ===== MOBILE VIEW STYLES ===== */\n        .mobile-toggle-btn {\n            position: fixed;\n            bottom: 100px;\n            left: 20px;\n            width: 56px;\n            height: 56px;\n            border-radius: 50%;\n            background: linear-gradient(135deg, var(--brand-primary), #1e40af);\n            border: none;\n            color: white;\n            font-size: 24px;\n            cursor: pointer;\n            box-shadow: 0 4px 15px rgba(15, 23, 42, 0.3);\n            z-index: 9999;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .mobile-toggle-btn:hover { transform: scale(1.1); }\n        .mobile-toggle-btn.desktop-mode { background: linear-gradient(135deg, #059669, #10b981); }\n        \n        #mobile-view { display: none; padding: 16px; padding-bottom: 100px; }\n        \n        body.mobile-active .cover-section,\n        body.mobile-active #detailed-report,\n        body.mobile-active #insurance-report-content { display: none !important; }\n        body.mobile-active #mobile-view { display: block !important; }\n        body.mobile-active .floating-footer { display: none !important; }\n        \n        .mv-header {\n            text-align: center;\n            padding: 20px;\n            background: linear-gradient(135deg, var(--brand-primary), #1e40af);\n            border-radius: 16px;\n            margin-bottom: 20px;\n            color: white;\n        }\n        .mv-greeting { font-size: 16px; opacity: 0.9; margin-bottom: 8px; }\n        .mv-total { font-size: 32px; font-weight: 700; margin-bottom: 4px; }\n        .mv-yield { font-size: 18px; color: #4ade80; font-weight: 600; }\n        .mv-switch-btn {\n            display: inline-flex; align-items: center; gap: 8px;\n            margin-top: 16px; padding: 10px 20px;\n            background: rgba(255,255,255,0.15);\n            border: 1px solid rgba(255,255,255,0.3);\n            border-radius: 25px; color: white; font-size: 14px;\n            cursor: pointer; transition: all 0.2s;\n        }\n        .mv-switch-btn:hover { background: rgba(255,255,255,0.25); }\n        \n        .mv-accordion {\n            background: var(--bg-card);\n            border-radius: 12px;\n            margin-bottom: 12px;\n            box-shadow: var(--shadow-sm);\n            overflow: hidden;\n        }\n        .mv-acc-header {\n            padding: 16px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n            transition: background 0.2s;\n        }\n        .mv-acc-header:hover { background: var(--bg-subtle); }\n        .mv-accordion.open .mv-acc-header { border-bottom: 1px solid var(--border-light); }\n        \n        .mv-cat-info { display: flex; align-items: center; gap: 12px; }\n        .mv-cat-icon {\n            width: 40px; height: 40px; border-radius: 10px;\n            display: flex; align-items: center; justify-content: center;\n            font-size: 18px; color: white;\n        }\n        .mv-cat-title { font-weight: 700; font-size: 15px; color: var(--brand-primary); }\n        .mv-cat-sub { font-size: 11px; color: var(--positive); margin-top: 2px; }\n        .mv-cat-amount { font-weight: 700; font-size: 16px; color: var(--brand-primary); }\n        .mv-chevron { margin-right: 8px; transition: transform 0.3s; color: var(--text-light); }\n        .mv-accordion.open .mv-chevron { transform: rotate(180deg); }\n        \n        .mv-acc-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; background: var(--bg-subtle); }\n        .mv-accordion.open .mv-acc-body { max-height: 3000px; }\n        \n        .mv-product { padding: 16px; border-bottom: 1px solid var(--border-light); }\n        .mv-product:last-child { border-bottom: none; }\n        .mv-prod-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }\n        .mv-prod-name { display: flex; align-items: center; gap: 10px; }\n        .mv-prod-logo {\n            width: 32px; height: 32px; border-radius: 8px;\n            display: flex; align-items: center; justify-content: center;\n            color: white; font-size: 11px; font-weight: 700;\n        }\n        .mv-prod-title { font-weight: 600; font-size: 14px; color: var(--text-main); }\n        .mv-prod-amount { font-weight: 700; font-size: 15px; color: var(--brand-primary); }\n        \n        .mv-tracks { font-size: 13px; }\n        .mv-track-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light); }\n        .mv-track-row:last-child { border-bottom: none; }\n        .mv-track-name { color: var(--text-main); }\n        .mv-track-yield { font-weight: 600; }\n        .mv-track-yield.pos { color: var(--positive); }\n        .mv-track-yield.neg { color: var(--negative); }\n        \n        .mv-hint {\n            margin-top: 12px; padding: 12px;\n            background: linear-gradient(135deg, #fef3c7, #fde68a);\n            border-radius: 8px; font-size: 12px; color: #92400e;\n            display: flex; align-items: flex-start; gap: 8px;\n        }\n        .mv-hint i { font-size: 16px; flex-shrink: 0; }\n        \n        @media print { .mobile-toggle-btn, #mobile-view { display: none !important; } }\n\n    \n/* Mobile Footer Navigation */\n.mv-footer-nav {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    background: var(--bg-card);\n    display: flex;\n    justify-content: space-around;\n    padding: 8px 0 12px 0;\n    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);\n    z-index: 9998;\n    border-top: 1px solid var(--border-light);\n}\n.mv-nav-item {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 4px;\n    background: none;\n    border: none;\n    color: var(--text-secondary);\n    font-size: 11px;\n    font-family: inherit;\n    cursor: pointer;\n    padding: 4px 16px;\n    transition: color 0.2s;\n}\n.mv-nav-item i { font-size: 18px; }\n.mv-nav-item.active { color: var(--brand-primary); }\n\n    </style>\n</head>\n<body>\n\n    <!-- MOBILE TOGGLE -->\n    <button class=\"mobile-toggle-btn no-print\" onclick=\"toggleMobileView()\" title=\"转爪转 \">\n        <i class=\"fas fa-mobile-alt\" id=\"mv-toggle-icon\"></i>\n    </button>\n\n    <!-- MOBILE VIEW CONTAINER -->\n    <div id=\"mobile-view\">\n        <div class=\"mv-header\">\n            <div class=\"mv-greeting\">砖 ${firstName} </div>\n            <div class=\"mv-total\">${formatCurrency(grandTotal)}</div>\n            <div class=\"mv-yield\">+${totalWeightedYield.toFixed(1)}% 转转 砖</div>\n            <button class=\"mv-switch-btn\" onclick=\"toggleMobileView()\">\n                <i class=\"fas fa-desktop\"></i> 注专 转爪 \n            </button>\n        </div>\n        <div id=\"mv-content\"></div>\n        <nav class=\"mv-footer-nav\">\n            <button class=\"mv-nav-item\" onclick=\"mvGoHome()\">\n                <i class=\"fas fa-home\"></i>\n                <span>转</span>\n            </button>\n            <button class=\"mv-nav-item active\" onclick=\"mvGoToPension()\">\n                <i class=\"fas fa-chart-pie\"></i>\n                <span>驻住</span>\n            </button>\n            <button class=\"mv-nav-item\" onclick=\"mvGoToInsurance()\">\n                <i class=\"fas fa-shield-alt\"></i>\n                <span></span>\n            </button>\n        </nav>\n    </div>\n\n\n    <!-- COVER PAGE -->\n    <div class=\"cover-section\">\n        <div class=\"container container-narrow\">\n            <header class=\"cover-header\">\n                <div class=\"logo-icon\"><i class=\"fas fa-chart-pie\"></i></div>\n                <div class=\"date-badge\">${currentMonth}</div>\n                <h1 class=\"cover-title\">住拽专 砖转 转 转拽</h1>\n                <div class=\"cover-subtitle\">${customerName}, 转. ${customerId}</div>\n            </header>\n\n            <div class=\"nav-buttons\">\n                <button class=\"nav-btn\" onclick=\"scrollToReport()\">\n                    <i class=\"fas fa-chart-pie\"></i>\n                     驻住\n                </button>\n                <button class=\"nav-btn secondary\" onclick=\"scrollToInsurance()\">\n                    <i class=\"fas fa-shield-alt\"></i>\n                     \n                </button>\n            </div>\n\n            <div class=\"text-section\" style=\"margin-bottom: 30px; background: var(--bg-card); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow-sm);\">\n                <h2 style=\"color: var(--brand-primary); border-bottom: 2px solid var(--brand-accent); padding-bottom: 12px;\">${firstName} 砖,</h2>\n                <p style=\"font-size: 15px; line-height: 1.7;\"> 砖 爪 驻  砖  转  住转  砖 拽 .  驻砖专 砖转 爪注 住 砖拽注, 转   注拽 专 住  砖.</p>\n                <p style=\"font-size: 15px; line-height: 1.7; margin-top: 12px;\">砖 转拽 住  注 注 <strong>${formatCurrency(grandTotal)}</strong> 注 转砖 砖 <strong class=\"text-green\">+${totalWeightedYield.toFixed(1)}%</strong> 转转 砖. 转拽 砖专 注 砖驻 转转 砖 -<strong>${avgExpTotal.toFixed(0)}%</strong>. ${customerAge ? ` (${customerAge}), 砖驻 转   <strong>${recommendedExposure.min}%-${recommendedExposure.max}%</strong> (驻专驻 ${recommendedExposure.label}).` : ''}</p>\n            </div>\n\n            <div class=\"content-grid\">\n                <div class=\"text-section\">\n                    <h2>  砖</h2>\n                    <ul style=\"margin: 12px 20px 0 0; padding: 0; list-style: none; font-size: 14px; line-height: 1.8;\">\n                        <li style=\"margin-bottom: 10px;\"> <strong>爪 注 爪专</strong> - 驻转转 转  住 砖拽注 注 转 转砖 砖驻 转转</li>\n                        <li style=\"margin-bottom: 10px;\"><span style=\"display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #fef3c7, #fde68a); margin-left: 6px;\"><svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#92400e\" stroke-width=\"2\"><path d=\"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"9\" cy=\"7\" r=\"4\"/><path d=\"M23 21v-2a4 4 0 0 0-3-3.87\"/><path d=\"M16 3.13a4 4 0 0 1 0 7.75\"/></svg></span> <strong>拽 爪</strong> - 爪 转 专砖转  砖 爪转 驻转专</li>\n                        <li style=\"margin-bottom: 10px;\"><span style=\"display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #3b82f6, #1e40af); margin-left: 6px;\"><svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M4 19.5A2.5 2.5 0 0 1 6.5 17H20\"/><path d=\"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\"/></svg></span> <strong>拽 </strong> - (拽专转 驻住) 爪 转 住 , 拽爪转 拽 爪驻, 住 转 砖专</li>\n                    </ul>\n                </div>\n\n                <div class=\"text-section\">\n                    <h2>转 砖拽 </h2>\n                    <p style=\"white-space: pre-line;\">${marketTrendsText}</p>\n                </div>\n            </div>\n\n            <div class=\"text-section\" style=\"margin-top: 30px;\">\n                <h2>转  转拽 砖</h2>\n                \n                ${totalAlerts >= 3 ? `\n                <div class=\"highlight-box\" style=\"margin-top: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-right-color: #f59e0b;\">\n                    <p style=\"margin: 0; line-height: 1.7;\"><span style=\"font-size: 28px; margin-left: 8px;\"></span>拽 注转 砖注专 转拽 驻住 砖 注  拽转 <strong>${totalAlerts}</strong> 驻砖专转 住 砖拽注 驻 转 爪专 拽 转拽  住 砖拽注 注 转砖转 转专 专转 砖驻  转.</p>\n                    \n                </div>\n                ` : totalAlerts >= 1 ? `\n                <div class=\"highlight-box\" style=\"margin-top: 16px; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-right-color: #10b981;\">\n                    <p style=\"margin: 0; line-height: 1.7;\"> 砖 注 砖转拽 驻住 砖 爪 爪转 注 爪驻转.</p>\n                    <p style=\"margin: 12px 0 0 0; line-height: 1.7;\">注 转,   砖 爪 转 驻爪 爪专 拽, 住  <strong>${totalAlerts}</strong> 拽转 拽 住  驻砖专转 注专 住 注 转砖转 转专 专转 砖驻  转. 转/ 转 转 爪注转 住 专 () 驻注 爪 砖 爪专, 砖专 爪 驻转 砖 转 拽驻. 砖 砖, 注专  注 驻专 拽 转 砖.</p>\n                </div>\n                ` : `\n                <div class=\"highlight-box\" style=\"margin-top: 16px; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-right-color: #10b981;\">\n                    <p style=\"margin: 0; line-height: 1.7;\">注专 注 转 注,  砖 注 砖转拽 驻住 砖 转驻拽 爪专 驻转.</p>\n                    <p style=\"margin: 12px 0 0 0; line-height: 1.7;\"> 注 , 住 砖拽注 爪专 砖专砖转 转 转 驻 砖专  爪专 爪注 砖.</p>\n                </div>\n                `}\n            </div>\n            </div>\n\n            \n        </div>\n    </div>\n\n    <div class=\"page-break\"></div>\n\n    <!-- DETAILED REPORT -->\n    <div id=\"detailed-report\" class=\"report-section\">\n        <div class=\"container container-wide\">\n\n            <header class=\"header-card\">\n                <div class=\"container header-content\">\n                    <div class=\"brand\">\n                        <div class=\"brand-icon-box\"><i class=\"fas fa-chart-pie\"></i></div>\n                        <div class=\"brand-text\">\n                            <h1>Portfolio Expert</h1>\n                            <p> 注砖专 驻住</p>\n                        </div>\n                    </div>\n                    <div class=\"client-info-box\">\n                        <div class=\"client-name-lg\">${customerName}</div>\n                        <div class=\"report-date-sm\"> 爪  -${currentDate}</div>\n                    </div>\n                </div>\n            </header>\n\n            <section class=\"dashboard-summary\">\n                <div class=\"summary-header\">\n                    <div class=\"total-value\">\n                        <div class=\"total-label\">砖 转拽 </div>\n                        <div class=\"total-amount\">${formatCurrency(grandTotal)}</div>\n                        <div class=\"total-sub\"><span class=\"text-green\"><i class=\"fas fa-arrow-up\"></i> +${totalWeightedYield.toFixed(1)}%</span> 转转 砖</div>\n                    </div>\n                </div>\n                <div class=\"dynamic-chart-section\" style=\"background: var(--bg-card); padding: 24px; border-radius: var(--radius); margin-top: 20px;\">\n                <!-- Header & Tabs -->\n                <div style=\"display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 24px;\">\n                    <div id=\"chartTitle\" style=\"font-size: 16px; font-weight: 600; color: var(--brand-primary);\">转 爪转 转拽 (12 砖)</div>\n                    \n                    <div class=\"chart-tabs\" style=\"display: flex; gap: 8px; flex-wrap: wrap;\">\n                        <button onclick=\"updateDynamicChart('yields')\" id=\"btn-yields\" class=\"chart-tab-btn active\">转砖转 ()</button>\n                        <button onclick=\"updateDynamicChart('stocks-capital')\" id=\"btn-stocks-capital\" class=\"chart-tab-btn\">砖驻 驻 祝 ()</button>\n                        <button onclick=\"updateDynamicChart('stocks-annuity')\" id=\"btn-stocks-annuity\" class=\"chart-tab-btn\">砖驻 驻 祝 (拽爪转)</button>\n                    </div>\n                </div>\n\n                <!-- Canvas -->\n                <div style=\"position: relative; height: 300px; width: 100%;\">\n                    <canvas id=\"dynamicChart\"></canvas>\n                </div>\n\n                <!-- Dynamic Footer Stats -->\n                <div id=\"chartFooter\" style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-light); text-align: center;\"></div>\n            </div>\n            <div id=\"dashboard-container\"<div id=\"dashboard-container\" class=\"holdings-container\"></div>\n            </section>\n        </div>\n    </div>\n\n    <div class=\"floating-footer no-print\">\n        <button class=\"btn btn-ghost\" onclick=\"backToHome()\"><i class=\"fas fa-home\"></i> 专 注 专砖</button>\n        <button class=\"btn btn-ghost\" onclick=\"window.print()\"><i class=\"fas fa-print\"></i> 驻住</button>\n        <button class=\"btn btn-primary\" onclick=\"exportToExcel()\"><i class=\"fas fa-file-excel\"></i> 爪 拽住</button>\n    </div>\n\n    <script>\n        const COMPANY_URLS = ${JSON.stringify(COMPANY_URLS)};\n        const portfolioData = ${portfolioJson};\n        const categoryOrder = ${JSON.stringify(categoryOrder)};\n\n        const formatCurrency = num => new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(num || 0);\n        const formatPercent = num => (num !== null && num !== undefined && !isNaN(num)) ? num.toFixed(1) + '%' : '-';\n        const calcEfficiency = (y, exp) => (!exp || exp === 0 || !y) ? 0 : ((y / exp) * 10).toFixed(1);\n\n        function getStarRating(score) {\n            const s = parseFloat(score);\n            let stars = '';\n            for (let i = 1; i <= 5; i++) {\n                stars += i <= Math.round(s) ? '<span class=\"fill\"></span>' : '<span></span>';\n            }\n            return stars;\n        }\n\n        function getCategoryIcon(catName) {\n            const icons = {\n                '驻住': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M12 2L2 7l10 5 10-5-10-5z\"/><path d=\"M2 17l10 5 10-5\"/><path d=\"M2 12l10 5 10-5\"/></svg>',\n                '': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z\"/><path d=\"M2 9v1c0 1.1.9 2 2 2h1\"/></svg>',\n                '砖转转': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M22 10v6M2 10l10-5 10 5-10 5z\"/><path d=\"M6 12v5c0 2 2 3 6 3s6-1 6-3v-5\"/></svg>',\n                '砖拽注转 专转': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"8\"/><path d=\"M12 8v8\"/><path d=\"M8 12h8\"/></svg>',\n                '': '<svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"><path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z\"/></svg>'\n            };\n            return icons[catName] || icons['砖拽注转 专转'];\n        }\n\n        function getCategoryColor(catName) {\n            const colors = {\n                '驻住': 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)',\n                '': 'linear-gradient(135deg, #dc2626 0%, #f87171 100%)',\n                '砖转转': 'linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)',\n                '砖拽注转 专转': 'linear-gradient(135deg, #059669 0%, #34d399 100%)',\n                '': 'linear-gradient(135deg, #0891b2 0%, #22d3ee 100%)'\n            };\n            return colors[catName] || colors['砖拽注转 专转'];\n        }\n\n        function getFallbackColor(name) {\n            const n = name || '';\n            if (n.includes('驻拽住') || n.includes('驻拽住')) return '#f97316';\n            if (n.includes('')) return '#4f46e5';\n            if (n.includes('专')) return '#2563eb';\n            if (n.includes('')) return '#0d9488';\n            if (n.includes('')) return '#0891b2';\n            if (n.includes('砖专')) return '#16a34a';\n            if (n.includes('专')) return '#9333ea';\n            if (n.includes('住')) return '#0284c7';\n            if (n.includes('专')) return '#e11d48';\n            if (n.includes('')) return '#d97706';\n            return '#475569';\n        }\n\n        function getCompanyLoginUrl(name) {\n            for (const [key, url] of Object.entries(COMPANY_URLS)) {\n                if (name && name.includes(key)) return url;\n            }\n            return '#';\n        }\n\n        function cleanName(name, companyName) {\n            if (!name) return '';\n            let cleaned = name;\n            if (companyName) {\n                cleaned = cleaned.replace(new RegExp(companyName, 'gi'), '');\n                const companyFirstWord = companyName.split(' ')[0];\n                if (companyFirstWord) cleaned = cleaned.replace(new RegExp(companyFirstWord, 'gi'), '');\n            }\n            cleaned = cleaned.replace(/注\"/g, ' ').replace(/-/g, ' ').replace(/\\\\s+/g, ' ').trim();\n            return cleaned.length > 2 ? cleaned : name;\n        }\n\n        function toggle(id) {\n            const el = document.getElementById(id);\n            const chevron = document.getElementById('chevron-' + id);\n            const isOpening = el && !el.classList.contains('open');\n\n            // Determine what level we're toggling\n            const isProduct = id.includes('-prod-');\n            const isCategory = id.startsWith('cat-') && !isProduct;\n\n            // Close same-level accordions only\n            document.querySelectorAll('.accordion-body.open').forEach(function(openEl) {\n                const openId = openEl.id;\n                const openIsProduct = openId.includes('-prod-') && !openId.includes('-t');\n                const openIsCategory = openId.startsWith('cat-') && !openId.includes('-prod-');\n                const openIsTrack = openId.includes('-t');\n\n                // If clicking a product, close other products and tracks (but not categories)\n                if (isProduct && (openIsProduct || openIsTrack)) {\n                    openEl.classList.remove('open');\n                    var chev = document.getElementById('chevron-' + openId);\n                    if (chev) chev.classList.remove('open');\n                }\n                // If clicking a category, close other categories (and their children)\n                else if (isCategory && openIsCategory) {\n                    openEl.classList.remove('open');\n                    var chev = document.getElementById('chevron-' + openId);\n                    if (chev) chev.classList.remove('open');\n                }\n            });\n\n            // Now open the clicked one if it was closed\n            if (isOpening && el) {\n                el.classList.add('open');\n                if (chevron) chevron.classList.add('open');\n            }\n        }\n\n        function toggleTrack(id) {\n            const el = document.getElementById(id);\n            const isOpening = el && !el.classList.contains('open');\n\n            // Close only other tracks (not products or categories)\n            document.querySelectorAll('.accordion-body.open').forEach(function(openEl) {\n                if (openEl.id.includes('-t')) {\n                    openEl.classList.remove('open');\n                    var chevron = document.getElementById('chevron-' + openEl.id);\n                    if (chevron) chevron.classList.remove('open');\n                }\n            });\n\n            // Now open the clicked one if it was closed\n            if (isOpening && el) {\n                el.classList.add('open');\n                var chevron = document.getElementById('chevron-' + id);\n                if (chevron) chevron.classList.add('open');\n            }\n        }\n\n        function toggleInsuranceTrack(id) {\n            const el = document.getElementById(id);\n            const chevron = document.getElementById('chevron-ins-' + id);\n            if (el) el.classList.toggle('open');\n            if (chevron) chevron.classList.toggle('open');\n        }\n\n        function showPensionModal(modalId) {\n            const modal = document.getElementById(modalId);\n            if (modal) modal.classList.add('open');\n            event.stopPropagation();\n        }\n\n        function closePensionModal(modalId) {\n            const modal = document.getElementById(modalId);\n            if (modal) modal.classList.remove('open');\n            event.stopPropagation();\n        }\n\n        function renderPensionBookIcon(product, prodId) {\n            if (!product.pensionData) return '';\n\n            const pd = product.pensionData;\n            const survivorTotal = (pd.kitzbaLeAlman || 0) + (pd.kitzbaLeYetom || 0);\n            const modalId = 'pension-modal-' + prodId;\n\n            // Book icon + Modal (with projection box inside)\n            return \\`\n                <span class=\"pension-book-icon\" onclick=\"showPensionModal('\\${modalId}'); event.stopPropagation();\" title=\"抓    注 拽专 驻住 砖\">\n                    <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z\"/>\n                    </svg>\n                </span>\n                <!-- Pension Modal with Projection -->\n                <div id=\"\\${modalId}\" class=\"pension-modal\" onclick=\"closePensionModal('\\${modalId}')\">\n                    <div class=\"pension-modal-content\" onclick=\"event.stopPropagation()\">\n                        <div class=\"modal-header\">\n                            <h3>驻专 拽专 驻住</h3>\n                            <button class=\"modal-close\" onclick=\"closePensionModal('\\${modalId}')\">&times;</button>\n                        </div>\n                        <div class=\"modal-body\">\n                            <!-- Projection Box inside modal -->\n                            <div class=\"pension-projection-box\" style=\"margin: 0 0 20px 0;\">\n                                <div class=\"projection-icon\">\n                                    <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                                        <path d=\"M9 18h6M10 22h4M12 2v1M4.22 4.22l.71.71M1 12h1M4.22 19.78l.71-.71M12 17a5 5 0 100-10 5 5 0 000 10z\"/>\n                                    </svg>\n                                </div>\n                                <div class=\"projection-content\">\n                                    <div class=\"projection-text\">\n                                        转 转 转 砖专  砖 <strong>\\${formatCurrency(pd.insuredSalary)}</strong>,\n                                        拽爪转 驻住  砖  <strong>\\${pd.retirementAge}</strong> 注转 注:\n                                    </div>\n                                    <div class=\"projection-amount\">\\${formatCurrency(pd.kitzbatZiknaKolelPremiot)}<span>/砖</span></div>\n                                </div>\n                                <div class=\"projection-couple\">\n                                    <svg width=\"48\" height=\"48\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\">\n                                        <circle cx=\"9\" cy=\"7\" r=\"3\"/>\n                                        <circle cx=\"15\" cy=\"7\" r=\"3\"/>\n                                        <path d=\"M5 21v-2a4 4 0 014-4h2M15 15a4 4 0 014 4v2M12 15v6\"/>\n                                    </svg>\n                                </div>\n                            </div>\n                            <!-- Insurance Track -->\n                            <div class=\"insurance-track-box\">\n                                <div class=\"insurance-track-label\">住 </div>\n                                <div class=\"insurance-track-items\">\n                                    <div class=\"insurance-track-item\">\n                                        <span class=\"track-percent\">\\${(pd.disabilityCoverage * 100).toFixed(0)}%</span>\n                                        <span class=\"track-type\">转</span>\n                                    </div>\n                                    <div class=\"insurance-track-item\">\n                                        <span class=\"track-percent\">\\${(pd.partnerCoverage * 100).toFixed(0)}%</span>\n                                        <span class=\"track-type\">砖专 /转 </span>\n                                    </div>\n                                    <div class=\"insurance-track-item\">\n                                        <span class=\"track-percent\">\\${(pd.orphanCoverage * 100).toFixed(0)}%</span>\n                                        <span class=\"track-type\">砖专 转</span>\n                                    </div>\n                                </div>\n                            </div>\n                            <!-- Detail cards -->\n                            <div class=\"modal-grid\">\n                                <div class=\"modal-item\">\n                                    <div class=\"modal-label\">砖专 </div>\n                                    <div class=\"modal-value\">\\${formatCurrency(pd.insuredSalary)}</div>\n                                </div>\n                                <div class=\"modal-item\">\n                                    <div class=\"modal-label\">拽爪转 转</div>\n                                    <div class=\"modal-value\">\\${formatCurrency(pd.kitzbatNehut)}/砖</div>\n                                </div>\n                                <div class=\"modal-item\">\n                                    <div class=\"modal-label\">拽爪转 砖专</div>\n                                    <div class=\"modal-value\">\\${formatCurrency(survivorTotal)}/砖</div>\n                                </div>\n                                <div class=\"modal-item\">\n                                    <div class=\"modal-label\">驻拽 专</div>\n                                    <div class=\"modal-value\">\\${formatCurrency(pd.lastDepositAmount)}</div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            \\`;\n        }\n\n        function showMutavimModal(modalId) {\n            const modal = document.getElementById(modalId);\n            if (modal) modal.classList.add('open');\n            event.stopPropagation();\n        }\n\n        function closeMutavimModal(modalId) {\n            const modal = document.getElementById(modalId);\n            if (modal) modal.classList.remove('open');\n            event.stopPropagation();\n        }\n\n        function renderMutavimIcon(mutavim, prodId) {\n            if (!mutavim || mutavim.length === 0) return '';\n            \n            const modalId = 'mutavim-modal-' + prodId;\n            \n            const mutavimRows = mutavim.map(m => {\n                const fullName = ((m.shemPrati || '') + ' ' + (m.shemMishpaha || '')).trim();\n                const idNumber = m.misparMezahe || m.misparZihuy || '-';\n                const percent = m.ahuzMutav ? (m.ahuzMutav * 100).toFixed(0) + '%' : '-';\n                return \\`\n                    <div class=\"mutavim-modal-item\">\n                        <div>\n                            <div class=\"mutavim-modal-name\">\\${fullName || ' 爪'}</div>\n                            <div class=\"mutavim-modal-id\">转.: \\${idNumber}</div>\n                        </div>\n                        <div class=\"mutavim-modal-percent\">\\${percent}</div>\n                    </div>\n                \\`;\n            }).join('');\n            \n            return \\`\n                <span class=\"mutavim-icon-btn\" onclick=\"showMutavimModal('\\${modalId}'); event.stopPropagation();\">\n                    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                        <path d=\"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/>\n                        <circle cx=\"9\" cy=\"7\" r=\"4\"/>\n                        <path d=\"M23 21v-2a4 4 0 0 0-3-3.87\"/>\n                        <path d=\"M16 3.13a4 4 0 0 1 0 7.75\"/>\n                    </svg>\n                </span>\n                <div id=\"\\${modalId}\" class=\"mutavim-modal\" onclick=\"closeMutavimModal('\\${modalId}')\">\n                    <div class=\"mutavim-modal-content\" onclick=\"event.stopPropagation()\">\n                        <div class=\"mutavim-modal-header\">\n                            <h3><span></span> </h3>\n                            <button class=\"mutavim-modal-close\" onclick=\"closeMutavimModal('\\${modalId}')\">&times;</button>\n                        </div>\n                        <div class=\"mutavim-modal-body\">\n                            <div class=\"mutavim-modal-list\">\n                                \\${mutavimRows}\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            \\`;\n        }\n\n\n        function scrollToReport() {\n            // Hide cover section\n            const coverSection = document.querySelector('.cover-section');\n            if (coverSection) coverSection.style.display = 'none';\n            \n            // Hide insurance report content\n            const insuranceReport = document.getElementById('insurance-report-content');\n            if (insuranceReport) insuranceReport.style.display = 'none';\n            \n            // Show pension report\n            const pensionReport = document.getElementById('detailed-report');\n            if (pensionReport) {\n                pensionReport.style.display = 'block';\n                window.scrollTo({ top: 0, behavior: 'smooth' });\n            }\n        }\n\n        function scrollToInsurance() {\n            // Hide cover section\n            const coverSection = document.querySelector('.cover-section');\n            if (coverSection) coverSection.style.display = 'none';\n            \n            // Hide pension report\n            const pensionReport = document.getElementById('detailed-report');\n            if (pensionReport) pensionReport.style.display = 'none';\n            \n            // Show insurance report content\n            const insuranceReport = document.getElementById('insurance-report-content');\n            if (insuranceReport) {\n                insuranceReport.style.display = 'block';\n                window.scrollTo({ top: 0, behavior: 'smooth' });\n            }\n        }\n        \n        function backToHome() {\n            // Hide reports\n            const pensionReport = document.getElementById('detailed-report');\n            if (pensionReport) pensionReport.style.display = 'none';\n            \n            const insuranceReport = document.getElementById('insurance-report-content');\n            if (insuranceReport) insuranceReport.style.display = 'none';\n            \n            // Show cover section\n            const coverSection = document.querySelector('.cover-section');\n            if (coverSection) {\n                coverSection.style.display = 'flex';\n                window.scrollTo({ top: 0, behavior: 'smooth' });\n            }\n        }\n\n        function exportToExcel() {\n            let excelData = [[\" 转拽 拽\", \"${customerName}\"], [\"转专\", new Date().toLocaleDateString('he-IL')], []];\n            categoryOrder.forEach(cat => {\n                if (portfolioData[cat] && portfolioData[cat].length > 0) {\n                    excelData.push([cat]);\n                    excelData.push([\"爪专\", \"砖 爪专\", \"住驻专 砖\", \"转专 爪专\", \"住\", \"拽 住\", \"转专 住\", \"转砖 YTD\", \"转砖 3 砖\", \"砖驻\", \" \"]);\n                    portfolioData[cat].forEach(p => {\n                        p.tracks.forEach(t => {\n                            excelData.push([\n                                p.companyName, p.productName, p.productNumber, p.totalAccumulation,\n                                t.trackName, t.trackId || '-', t.trackAccumulation,\n                                (t.marketData.ytdYield || '-') + '%', (t.marketData.return3Y || '-') + '%',\n                                (t.marketData.stockExposure || '-') + '%', (t.fee || '-') + '%'\n                            ]);\n                        });\n                    });\n                    excelData.push([]);\n                }\n            });\n            const ws = XLSX.utils.aoa_to_sheet(excelData);\n            const wb = XLSX.utils.book_new();\n            XLSX.utils.book_append_sheet(wb, ws, \"Portfolio\");\n            XLSX.writeFile(wb, \"Portfolio_Report.xlsx\");\n        }\n\n        \n        function renderMutavim(mutavim) {\n            if (!mutavim || mutavim.length === 0) return '';\n            const rows = mutavim.map(m => {\n                const name = (m.shemPrati || '') + ' ' + (m.shemMishpaha || '');\n                const relation = m.sugZika?.description || '-';\n                const purpose = m.mahutMutav?.description || '-';\n                const percent = m.ahuzMutav ? (m.ahuzMutav * 100).toFixed(0) + '%' : '-';\n                return '<div class=\"mutav-row\"><span class=\"mutav-name\">' + name.trim() + '</span><span class=\"mutav-relation\">' + relation + '</span><span class=\"mutav-purpose\">' + purpose + '</span><span class=\"mutav-percent\">' + percent + '</span></div>';\n            }).join('');\n            return '<div class=\"mutavim-section\"><div class=\"mutavim-header\"><span class=\"mutavim-icon\"></span><span class=\"mutavim-title\"></span></div><div class=\"mutavim-list\">' + rows + '</div></div>';\n        }\n\nfunction renderDashboard() {\n            const container = document.getElementById('dashboard-container');\n            let html = '';\n            let catIndex = 0;\n\n            categoryOrder.forEach(cat => {\n                const products = portfolioData[cat];\n                if (products && products.length > 0) {\n                    const catTotal = products.reduce((s, p) => s + p.totalAccumulation, 0);\n                    let catYieldSum = 0, catAccSum = 0;\n                    products.forEach(p => {\n                        p.tracks.forEach(t => {\n                            catYieldSum += (t.trackAccumulation || 0) * (t.marketData?.ytdYield || 0);\n                            catAccSum += t.trackAccumulation || 0;\n                        });\n                    });\n                    const catYield = catAccSum > 0 ? (catYieldSum / catAccSum).toFixed(1) : 0;\n                    const catId = 'cat-' + catIndex++;\n\n                    html += \\`\n                        <div class=\"category-card\">\n                            <div class=\"category-header\" onclick=\"toggle('\\${catId}')\">\n                                <div class=\"cat-main\">\n                                    <div class=\"cat-icon\" style=\"background: \\${getCategoryColor(cat)};\">\n                                        \\${getCategoryIcon(cat)}\n                                    </div>\n                                    <div class=\"cat-title\">\n                                        <h3>\\${cat}</h3>\n                                        <div class=\"cat-meta\">\\${products.length} 爪专</div>\n                                    </div>\n                                </div>\n                                <div class=\"cat-stats\">\n                                    <span class=\"amount\">\\${formatCurrency(catTotal)}</span>\n                                    <span class=\"yield\">+\\${catYield}%</span>\n                                </div>\n                            </div>\n                            <div id=\"\\${catId}\" class=\"accordion-body\">\n                                <div class=\"products-header\">\n                                    <div class=\"ph-name\">砖 爪专</div>\n                                    <div class=\"ph-number\">住壮 拽驻</div>\n                                    <div class=\"ph-accumulation\">爪专</div>\n                                    <div class=\"ph-fee\">状 驻拽</div>\n                                    <div class=\"ph-fee\">状 爪专</div>\n                                    <div class=\"ph-yield\">转砖</div>\n                                </div>\n                    \\`;\n\n                    products.forEach((product, pIdx) => {\n                        const prodId = catId + '-prod-' + pIdx;\n                        const companyColor = getFallbackColor(product.companyName);\n                        const initials = (product.companyName || '??').substring(0, 2);\n                        const loginUrl = getCompanyLoginUrl(product.companyName);\n\n                        // Calculate weighted average yield for product\n                        let prodYieldSum = 0, prodAccSum = 0;\n                        product.tracks.forEach(t => {\n                            prodYieldSum += (t.trackAccumulation || 0) * (t.marketData?.ytdYield || 0);\n                            prodAccSum += t.trackAccumulation || 0;\n                        });\n                        const prodAvgYield = prodAccSum > 0 ? (prodYieldSum / prodAccSum) : 0;\n\n                        const bookIcon = cat === '驻住' ? renderPensionBookIcon(product, prodId) : '';\n                        const mutavimIcon = renderMutavimIcon(product.mutavim, prodId);\n\n                        html += \\`\n                            <div class=\"product-row\" onclick=\"toggle('\\${prodId}'); event.stopPropagation();\">\n                                <div class=\"product-info\">\n                                    <span class=\"company-logo\" style=\"background: \\${companyColor}\">\\${initials}</span>\n                                    \\${bookIcon}\n                                    <div class=\"product-name\">\\${product.productName}</div>\\${mutavimIcon}\n                                </div>\n                                <div class=\"product-number\">\\${product.productNumber || '-'}</div>\n                                <div class=\"product-accumulation\">\\${formatCurrency(product.totalAccumulation)}</div>\n                                <div class=\"product-fee\">\\${parseFloat(product.depositFee.toFixed(2))}%</div>\n                                <div class=\"product-fee\">\\${parseFloat(product.accumulationFee.toFixed(3))}%</div>\n                                <div class=\"product-yield \\${prodAvgYield >= 0 ? 'text-green' : ''}\">\\${prodAvgYield >= 0 ? '+' : ''}\\${prodAvgYield.toFixed(1)}%</div>\n                                <i id=\"chevron-\\${prodId}\" class=\"chevron\"></i>\n                            </div>\n                            <div id=\"\\${prodId}\" class=\"accordion-body\">\n                                <div class=\"track-container\">\n                                    <div class=\"pension-section-header\" style=\"margin: 0 -24px 12px -24px; padding: 10px 24px;\">住 砖拽注</div>\n                        \\`;\n\n                        product.tracks.forEach((track, tIdx) => {\n                            const trackId = prodId + '-t' + tIdx;\n                            const ytd = track.marketData?.ytdYield ?? track.ytdYield ?? 0;\n                            const exposure = track.marketData?.exposure ?? track.marketData?.stockExposure ?? track.stockExposure ?? 0;\n                            const efficiency = calcEfficiency(ytd, exposure);\n                            const trackAcc = track.trackAccumulation || 0;\n                            const trackAccPercent = prodAccSum > 0 ? (trackAcc / prodAccSum * 100) : 0;\n                            const hasAlert = track.hasAlert && track.top3Alternatives && track.top3Alternatives.length > 0;\n                            const alertIcon = hasAlert ? '<span class=\"alert-icon\" title=\"砖 爪 \"><i class=\"fas fa-lightbulb\"></i></span>' : '';\n\n                            html += \\`\n                                <div class=\"track-row \\${hasAlert ? 'has-alert' : ''}\" onclick=\"toggleTrack('\\${trackId}'); event.stopPropagation();\">\n                                    <div class=\"track-title\">\n                                        <h5>\\${alertIcon}\\${track.trackName}</h5>\n                                    </div>\n                                    <div class=\"mini-stat\">\n                                        <div class=\"mini-val \\${ytd >= 0 ? 'text-green' : ''}\">\\${formatPercent(ytd)}</div>\n                                        <div class=\"mini-label\">转砖</div>\n                                    </div>\n                                    <div class=\"mini-stat exposure-stat\">\n                                        <div class=\"exposure-bar-wrapper\">\n                                            <div class=\"exposure-bar \\${exposure >= 70 ? 'high' : exposure >= 40 ? 'medium' : 'low'}\" style=\"width: \\${exposure}%;\"></div>\n                                        </div>\n                                        <div class=\"mini-label\">\\${exposure.toFixed(0)}% 砖驻</div>\n                                    </div>\n                                    <div class=\"mini-stat\">\n                                        <div class=\"mini-val\">\\${formatCurrency(trackAcc)}</div>\n                                        <div class=\"mini-label\">爪专</div>\n                                    </div>\n                                    <i id=\"chevron-\\${trackId}\" class=\"chevron\"></i>\n                                </div>\n                                <div id=\"\\${trackId}\" class=\"accordion-body\">\n                                    <div class=\"track-details\">\n                                        <div class=\"metrics-strip\">\n                                            <div class=\"metric-box\"><div class=\"label\">转砖 YTD</div><div class=\"val \\${ytd >= 0 ? 'text-green' : ''}\">\\${formatPercent(ytd)}</div></div>\n                                            <div class=\"metric-box\"><div class=\"label\">转砖 3 砖</div><div class=\"val\">\\${track.marketData?.return3Y ? formatPercent(track.marketData.return3Y) : '-'}</div></div>\n                                            <div class=\"metric-box\"><div class=\"label\">砖驻 转</div><div class=\"val\">\\${exposure.toFixed(1)}%</div></div>\n                                            <div class=\"metric-box\"><div class=\"label\"> 注转</div><div class=\"val\">\\${efficiency} <span class=\"efficiency-dots\" style=\"display: inline-flex; vertical-align: middle; margin-right: 4px;\">\\${getStarRating(efficiency)}</span></div></div>\n                                            <div class=\"metric-box\"><div class=\"label\">% 爪专</div><div class=\"val\">\\${trackAccPercent.toFixed(0)}%</div></div>\n                                        </div>\n                            \\`;\n\n                            if (hasAlert) {\n                                html += \\`\n                                    <div class=\"alt-table-wrapper\">\n                                        <div class=\"alt-table-header\">驻转 爪转 砖驻 </div>\n                                        <table class=\"alt-table\">\n                                            <thead><tr><th>砖 住</th><th>转砖</th><th>砖驻</th><th>注转</th></tr></thead>\n                                            <tbody>\n                                \\`;\n                                track.top3Alternatives.forEach(alt => {\n                                    const altEff = calcEfficiency(alt.yield, alt.exposure);\n                                    const altExp = typeof alt.exposure === 'number' ? alt.exposure.toFixed(1) : alt.exposure;\n                                    html += \\`\n                                        <tr>\n                                            <td><span class=\"badge-rec\">抓</span>\\${alt.name}</td>\n                                            <td class=\"text-green\">\\${formatPercent(alt.yield)}</td>\n                                            <td>\\${altExp}%</td>\n                                            <td>\\${altEff} <span class=\"efficiency-dots\" style=\"display: inline-flex; vertical-align: middle; margin-right: 4px;\">\\${getStarRating(altEff)}</span></td>\n                                        </tr>\n                                    \\`;\n                                });\n                                html += \\`\n                                            </tbody>\n                                        </table>\n                                    </div>\n                                    <div style=\"margin-top: 12px; text-align: left;\">\n                                        <a href=\"\\${loginUrl}\" target=\"_blank\" class=\"btn btn-primary\" style=\"display: inline-flex; font-size: 12px; padding: 8px 16px;\">\n                                            <i class=\"fas fa-external-link-alt\"></i> 砖 住\n                                        </a>\n                                    </div>\n                                \\`;\n                            }\n\n                            html += \\`\n                                    </div>\n                                </div>\n                            \\`;\n                        });\n\n                        html += \\`\n                                </div>\n                                </div>\n                        \\`;\n                    });\n\n                    html += \\`\n                            </div>\n                        </div>\n                    \\`;\n                }\n            });\n\n            container.innerHTML = html;\n        }\n\n        window.onload = renderDashboard;\n\n\n        // ===== MOBILE VIEW FUNCTIONS =====\n        function toggleMobileView() {\n            document.body.classList.toggle('mobile-active');\n            const icon = document.getElementById('mv-toggle-icon');\n            const btn = document.querySelector('.mobile-toggle-btn');\n            if (document.body.classList.contains('mobile-active')) {\n                icon.className = 'fas fa-desktop';\n                btn.classList.add('desktop-mode');\n                renderMobileView();\n            } else {\n                icon.className = 'fas fa-mobile-alt';\n                btn.classList.remove('desktop-mode');\n            }\n        }\n        \n        function toggleMobileAccordion(header) {\n            const accordion = header.parentElement;\n            const wasOpen = accordion.classList.contains('open');\n            \n            // Close ALL other mobile accordions first\n            document.querySelectorAll('.mv-accordion.open').forEach(function(openAcc) {\n                openAcc.classList.remove('open');\n            });\n            \n            // If it wasn't open, open it now\n            if (!wasOpen) {\n                accordion.classList.add('open');\n            }\n        }\n        \n        function renderMobileView() {\n            const container = document.getElementById('mv-content');\n            if (!container) return;\n            \n            const catColors = {\n                '驻住': '#1e3a8a', '': '#dc2626', '砖转转': '#7c3aed',\n                '砖拽注转 专转': '#059669', '': '#0891b2'\n            };\n            const catIcons = {\n                '驻住': 'fa-umbrella-beach', '': 'fa-piggy-bank',\n                '砖转转': 'fa-graduation-cap', '砖拽注转 专转': 'fa-chart-line',\n                '': 'fa-shield-alt'\n            };\n            const catLiquidity = {\n                '砖转转': '  专 6 砖转 转拽',\n                '砖拽注转 专转': '   注转'\n            };\n            \n            function getLogoColor(name) {\n                if (!name) return '#475569';\n                if (name.includes('驻拽住') || name.includes('驻拽住')) return '#f97316';\n                if (name.includes('')) return '#4f46e5';\n                if (name.includes('专')) return '#2563eb';\n                if (name.includes('')) return '#0d9488';\n                if (name.includes('')) return '#0891b2';\n                if (name.includes('砖专')) return '#16a34a';\n                if (name.includes('专')) return '#9333ea';\n                if (name.includes('住')) return '#0284c7';\n                if (name.includes('专')) return '#e11d48';\n                return '#475569';\n            }\n            \n            function getInitials(name) {\n                if (!name) return '?';\n                const w = name.split(' ');\n                return w.length >= 2 ? w[0][0] + w[1][0] : name.substring(0,2);\n            }\n            \n            let html = '';\n            \n            categoryOrder.forEach((cat, idx) => {\n                const products = portfolioData[cat];\n                if (!products || products.length === 0) return;\n                \n                let catTotal = 0;\n                products.forEach(p => { catTotal += p.totalAccumulation || 0; });\n                \n                const liq = catLiquidity[cat] || '';\n                \n                html += '<div class=\"mv-accordion\" data-idx=\"' + idx + '\">';\n                html += '<div class=\"mv-acc-header\" onclick=\"this.parentElement.classList.toggle(\\'open\\')\">';\n                html += '<div class=\"mv-cat-info\">';\n                html += '<div class=\"mv-cat-icon\" style=\"background:' + catColors[cat] + '\">';\n                html += '<i class=\"fas ' + (catIcons[cat] || 'fa-coins') + '\"></i></div>';\n                html += '<div><div class=\"mv-cat-title\">' + cat + '</div>';\n                if (liq) html += '<div class=\"mv-cat-sub\">' + liq + '</div>';\n                html += '</div></div>';\n                html += '<div style=\"display:flex;align-items:center\">';\n                html += '<span class=\"mv-cat-amount\">' + formatCurrency(catTotal) + '</span>';\n                html += '<i class=\"fas fa-chevron-down mv-chevron\"></i>';\n                html += '</div></div>';\n                \n                html += '<div class=\"mv-acc-body\">';\n                \n                products.forEach(prod => {\n                    const cname = prod.companyName || '';\n                    const pname = prod.productName || '';\n                    const hasRec = prod.tracks && prod.tracks.some(t => t.hasAlert && t.top3Alternatives && t.top3Alternatives.length > 0);\n                    \n                    html += '<div class=\"mv-product\">';\n                    html += '<div class=\"mv-prod-header\">';\n                    html += '<div class=\"mv-prod-name\">';\n                    html += '<div class=\"mv-prod-logo\" style=\"background:' + getLogoColor(cname) + '\">' + getInitials(cname) + '</div>';\n                    html += '<span class=\"mv-prod-title\">' + cname + (pname ? ' ' + pname : '') + '</span>';\n                    html += '</div>';\n                    html += '<span class=\"mv-prod-amount\">' + formatCurrency(prod.totalAccumulation) + '</span>';\n                    html += '</div>';\n                    \n                    html += '<div class=\"mv-tracks\">';\n                    if (prod.tracks) {\n                        prod.tracks.forEach(t => {\n                            const ytd = t.marketData?.ytdYield || 0;\n                            const cls = ytd >= 0 ? 'pos' : 'neg';\n                            const pfx = ytd >= 0 ? '+' : '';\n                            html += '<div class=\"mv-track-row\">';\n                            html += '<span class=\"mv-track-name\">' + (t.trackName || '住') + '</span>';\n                            html += '<span class=\"mv-track-yield ' + cls + '\">' + pfx + ytd.toFixed(1) + '%</span>';\n                            html += '</div>';\n                        });\n                    }\n                    html += '</div>';\n                    \n                    if (hasRec) {\n                        html += '<div class=\"mv-hint\"><i class=\"fas fa-lightbulb\"></i>';\n                        html += '<span>爪专  砖 驻砖专转 砖拽注 住驻转 注 转 砖驻专 转 爪注 转拽 - 注 ,  爪驻  砖.</span></div>';\n                    }\n                    \n                    html += '</div>';\n                });\n                \n                html += '</div></div>';\n            });\n            \n            container.innerHTML = html;\n        }\n\n    </script>\n\n    \n\n\n    <!-- Chart.js -->\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js\"></script>\n    <script>\n        // Data from report\n        const chartCompanyData = ${JSON.stringify(companyData)};\n        const chartTopProducts = ${JSON.stringify(topProducts)};\n        \n        // Color palette for companies\n        const companyColors = {\n            '驻拽住': '#f97316',\n            '驻拽住': '#f97316',\n            '砖专': '#3b82f6',\n            '': '#8b5cf6',\n            '专': '#10b981',\n            '专': '#eab308',\n            '': '#06b6d4',\n            '': '#ec4899',\n            '专': '#14b8a6',\n            '住': '#f43f5e',\n            '': '#84cc16',\n            '砖专': '#a855f7',\n            '驻住转': '#0ea5e9',\n            '专': '#94a3b8'\n        };\n        \n        function getCompanyColor(name) {\n            for (const [key, color] of Object.entries(companyColors)) {\n                if (name && name.includes(key)) return color;\n            }\n            return '#94a3b8';\n        }\n\n        let mainChart;\n        const chartTitle = document.getElementById('chartTitle');\n        \n        function updateDynamicChart(type) {\n            const ctx = document.getElementById('dynamicChart');\n            if (!ctx) return;\n            \n            if (mainChart) mainChart.destroy();\n            \n            let config;\n            \n            if (type === 'yields') {\n                // Line chart - yields by product (category + company)\n                const datasets = chartTopProducts.map((prod, idx) => ({\n                    label: prod.label,\n                    data: generateYieldData(prod.yield),\n                    borderColor: getCompanyColor(prod.company),\n                    borderWidth: 3,\n                    tension: 0.4,\n                    fill: false,\n                    pointRadius: 4,\n                    pointHoverRadius: 7,\n                    pointBackgroundColor: getCompanyColor(prod.company),\n                    pointBorderColor: '#fff',\n                    pointBorderWidth: 2\n                }));\n                \n                config = {\n                    type: 'line',\n                    data: {\n                        labels: ['', '驻专', '专抓', '驻专', '', '', '', '', '住驻', '拽', '', ''],\n                        datasets: datasets\n                    },\n                    options: getChartOptions('yields')\n                };\n                \n                chartTitle.innerText = '砖转 转砖转 驻 住 爪专 祝 ';\n                \n                // Footer\n                let footerHtml = chartTopProducts.map(prod => \n                    '<div style=\"border-left: 1px solid var(--border-light); padding: 0 8px;\">' +\n                    '<div style=\"font-size: 10px; color: var(--text-secondary);\">' + prod.label + '</div>' +\n                    '<div style=\"font-size: 16px; font-weight: 700; color: ' + getCompanyColor(prod.company) + ';\">+' + prod.yield + '%</div></div>'\n                ).join('');\n                document.getElementById('chartFooter').innerHTML = footerHtml;\n                document.getElementById('chartFooter').style.gridTemplateColumns = 'repeat(' + Math.min(chartTopProducts.length, 5) + ', 1fr)';\n                \n            } else if (type === 'stocks-capital') {\n                // Bar chart - Honi exposure by company\n                const honiCompanies = Object.values(chartCompanyData).filter(c => c.honiAcc > 0);\n                honiCompanies.sort((a, b) => b.honiAcc - a.honiAcc);\n                \n                const labels = honiCompanies.map(c => c.name);\n                const exposures = honiCompanies.map(c => parseFloat(c.honiAvgExposure));\n                const colors = honiCompanies.map(c => getCompanyColor(c.name));\n                const avgExposure = exposures.length > 0 ? (exposures.reduce((a,b) => a+b, 0) / exposures.length).toFixed(0) : 0;\n                \n                config = {\n                    type: 'bar',\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: '% 砖驻 砖拽转 转',\n                            data: exposures,\n                            backgroundColor: colors,\n                            borderRadius: 6,\n                            barPercentage: 0.6\n                        }]\n                    },\n                    options: getChartOptions('bar')\n                };\n                \n                chartTitle.innerText = '砖转 砖驻 转 驻 祝  (爪专 )';\n                document.getElementById('chartFooter').innerHTML = \n                    '<div style=\"grid-column: span 3;\"><div style=\"font-size: 12px; color: var(--text-secondary);\">砖驻 爪注转 转 ( 转拽 )</div>' +\n                    '<div style=\"font-size: 22px; font-weight: 700; color: var(--brand-primary);\">~' + avgExposure + '%</div></div>';\n                document.getElementById('chartFooter').style.gridTemplateColumns = '1fr';\n                \n            } else if (type === 'stocks-annuity') {\n                // Bar chart - Kitzba exposure by company\n                const kitzbaCompanies = Object.values(chartCompanyData).filter(c => c.kitzbaAcc > 0);\n                kitzbaCompanies.sort((a, b) => b.kitzbaAcc - a.kitzbaAcc);\n                \n                const labels = kitzbaCompanies.map(c => c.name);\n                const exposures = kitzbaCompanies.map(c => parseFloat(c.kitzbaAvgExposure));\n                const colors = kitzbaCompanies.map(c => getCompanyColor(c.name));\n                const avgExposure = exposures.length > 0 ? (exposures.reduce((a,b) => a+b, 0) / exposures.length).toFixed(0) : 0;\n                \n                config = {\n                    type: 'bar',\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: '% 砖驻 砖拽转 转',\n                            data: exposures,\n                            backgroundColor: colors,\n                            borderRadius: 6,\n                            barPercentage: 0.6\n                        }]\n                    },\n                    options: getChartOptions('bar')\n                };\n                \n                chartTitle.innerText = '砖转 砖驻 转 驻 祝  (爪专 拽爪转)';\n                document.getElementById('chartFooter').innerHTML = \n                    '<div style=\"grid-column: span 3;\"><div style=\"font-size: 12px; color: var(--text-secondary);\">砖驻 爪注转 转 ( 转拽 拽爪转)</div>' +\n                    '<div style=\"font-size: 22px; font-weight: 700; color: var(--brand-primary);\">~' + avgExposure + '%</div></div>';\n                document.getElementById('chartFooter').style.gridTemplateColumns = '1fr';\n            }\n            \n            mainChart = new Chart(ctx, config);\n            \n            // Update active tab\n            document.querySelectorAll('.chart-tab-btn').forEach(btn => {\n                btn.classList.remove('active');\n                btn.classList.add('secondary');\n            });\n            const activeBtn = document.getElementById('btn-' + type);\n            if (activeBtn) {\n                activeBtn.classList.remove('secondary');\n                activeBtn.classList.add('active');\n            }\n        }\n        \n        function getChartOptions(type) {\n            return {\n                responsive: true,\n                maintainAspectRatio: false,\n                interaction: {\n                    mode: 'nearest',\n                    intersect: true\n                },\n                hover: {\n                    mode: 'nearest',\n                    intersect: true\n                },\n                plugins: { \n                    legend: { \n                        display: type === 'yields',\n                        position: 'bottom',\n                        labels: { \n                            font: { family: 'Assistant', size: 11 }, \n                            usePointStyle: true,\n                            padding: 15\n                        }\n                    },\n                    tooltip: {\n                        enabled: true,\n                        backgroundColor: 'rgba(255, 255, 255, 0.98)',\n                        titleColor: '#1e293b',\n                        bodyColor: '#475569',\n                        borderColor: '#e2e8f0',\n                        borderWidth: 1,\n                        padding: 12,\n                        cornerRadius: 8,\n                        displayColors: true,\n                        boxPadding: 6,\n                        bodyFont: { family: 'Assistant', size: 13 },\n                        titleFont: { family: 'Assistant', size: 14, weight: '600' },\n                        callbacks: {\n                            title: function(context) {\n                                return context[0].label;\n                            },\n                            label: function(context) {\n                                const label = context.dataset.label || '';\n                                const value = context.parsed.y;\n                                return label + ': ' + value.toFixed(1) + '%';\n                            }\n                        }\n                    }\n                },\n                scales: {\n                    x: { grid: { display: false }, ticks: { font: { family: 'Assistant', size: 11 } } },\n                    y: { \n                        display: true, \n                        beginAtZero: true,\n                        max: type === 'bar' ? 100 : undefined,\n                        grid: { color: '#f1f5f9' },\n                        ticks: { \n                            font: { family: 'Assistant' },\n                            callback: function(value) { return value + '%'; }\n                        }\n                    }\n                },\n                animation: { duration: 600, easing: 'easeOutQuart' }\n            };\n        }\n        \n        function generateYieldData(finalYield) {\n            const data = [0];\n            for (let i = 1; i < 11; i++) {\n                data.push((finalYield * i / 11) + (Math.random() - 0.5) * 0.5);\n            }\n            data.push(finalYield);\n            return data;\n        }\n\n        // Hide tabs if no data\n        document.addEventListener('DOMContentLoaded', function() {\n            const honiCompanies = Object.values(chartCompanyData).filter(c => c.honiAcc > 0);\n            const kitzbaCompanies = Object.values(chartCompanyData).filter(c => c.kitzbaAcc > 0);\n            \n            if (honiCompanies.length === 0) {\n                const btn = document.getElementById('btn-stocks-capital');\n                if (btn) btn.style.display = 'none';\n            }\n            if (kitzbaCompanies.length === 0) {\n                const btn = document.getElementById('btn-stocks-annuity');\n                if (btn) btn.style.display = 'none';\n            }\n            \n            setTimeout(() => updateDynamicChart('yields'), 500);\n        });\n\n\n        // ===== MOBILE VIEW FUNCTIONS =====\n        function toggleMobileView() {\n            document.body.classList.toggle('mobile-active');\n            const icon = document.getElementById('mv-toggle-icon');\n            const btn = document.querySelector('.mobile-toggle-btn');\n            if (document.body.classList.contains('mobile-active')) {\n                icon.className = 'fas fa-desktop';\n                btn.classList.add('desktop-mode');\n                renderMobileView();\n            } else {\n                icon.className = 'fas fa-mobile-alt';\n                btn.classList.remove('desktop-mode');\n            }\n        }\n        \n        function toggleMobileAccordion(header) {\n            const accordion = header.parentElement;\n            const wasOpen = accordion.classList.contains('open');\n            \n            // Close ALL other mobile accordions first\n            document.querySelectorAll('.mv-accordion.open').forEach(function(openAcc) {\n                openAcc.classList.remove('open');\n            });\n            \n            // If it wasn't open, open it now\n            if (!wasOpen) {\n                accordion.classList.add('open');\n            }\n        }\n        \n        function renderMobileView() {\n            const container = document.getElementById('mv-content');\n            if (!container) return;\n            \n            const catColors = {\n                '驻住': '#1e3a8a', '': '#dc2626', '砖转转': '#7c3aed',\n                '砖拽注转 专转': '#059669', '': '#0891b2'\n            };\n            const catIcons = {\n                '驻住': 'fa-umbrella-beach', '': 'fa-piggy-bank',\n                '砖转转': 'fa-graduation-cap', '砖拽注转 专转': 'fa-chart-line',\n                '': 'fa-shield-alt'\n            };\n            const catLiquidity = {\n                '砖转转': '  专 6 砖转 转拽',\n                '砖拽注转 专转': '   注转'\n            };\n            \n            function getLogoColor(name) {\n                if (!name) return '#475569';\n                if (name.includes('驻拽住') || name.includes('驻拽住')) return '#f97316';\n                if (name.includes('')) return '#4f46e5';\n                if (name.includes('专')) return '#2563eb';\n                if (name.includes('')) return '#0d9488';\n                if (name.includes('')) return '#0891b2';\n                if (name.includes('砖专')) return '#16a34a';\n                if (name.includes('专')) return '#9333ea';\n                if (name.includes('住')) return '#0284c7';\n                if (name.includes('专')) return '#e11d48';\n                return '#475569';\n            }\n            \n            function getInitials(name) {\n                if (!name) return '?';\n                const w = name.split(' ');\n                return w.length >= 2 ? w[0][0] + w[1][0] : name.substring(0,2);\n            }\n            \n            let html = '';\n            \n            categoryOrder.forEach((cat, idx) => {\n                const products = portfolioData[cat];\n                if (!products || products.length === 0) return;\n                \n                let catTotal = 0;\n                products.forEach(p => { catTotal += p.totalAccumulation || 0; });\n                \n                const liq = catLiquidity[cat] || '';\n                \n                html += '<div class=\"mv-accordion\" data-idx=\"' + idx + '\">';\n                html += '<div class=\"mv-acc-header\" onclick=\"this.parentElement.classList.toggle(\\'open\\')\">';\n                html += '<div class=\"mv-cat-info\">';\n                html += '<div class=\"mv-cat-icon\" style=\"background:' + catColors[cat] + '\">';\n                html += '<i class=\"fas ' + (catIcons[cat] || 'fa-coins') + '\"></i></div>';\n                html += '<div><div class=\"mv-cat-title\">' + cat + '</div>';\n                if (liq) html += '<div class=\"mv-cat-sub\">' + liq + '</div>';\n                html += '</div></div>';\n                html += '<div style=\"display:flex;align-items:center\">';\n                html += '<span class=\"mv-cat-amount\">' + formatCurrency(catTotal) + '</span>';\n                html += '<i class=\"fas fa-chevron-down mv-chevron\"></i>';\n                html += '</div></div>';\n                \n                html += '<div class=\"mv-acc-body\">';\n                \n                products.forEach(prod => {\n                    const cname = prod.companyName || '';\n                    const pname = prod.productName || '';\n                    const hasRec = prod.tracks && prod.tracks.some(t => t.hasAlert && t.top3Alternatives && t.top3Alternatives.length > 0);\n                    \n                    html += '<div class=\"mv-product\">';\n                    html += '<div class=\"mv-prod-header\">';\n                    html += '<div class=\"mv-prod-name\">';\n                    html += '<div class=\"mv-prod-logo\" style=\"background:' + getLogoColor(cname) + '\">' + getInitials(cname) + '</div>';\n                    html += '<span class=\"mv-prod-title\">' + cname + (pname ? ' ' + pname : '') + '</span>';\n                    html += '</div>';\n                    html += '<span class=\"mv-prod-amount\">' + formatCurrency(prod.totalAccumulation) + '</span>';\n                    html += '</div>';\n                    \n                    html += '<div class=\"mv-tracks\">';\n                    if (prod.tracks) {\n                        prod.tracks.forEach(t => {\n                            const ytd = t.marketData?.ytdYield || 0;\n                            const cls = ytd >= 0 ? 'pos' : 'neg';\n                            const pfx = ytd >= 0 ? '+' : '';\n                            html += '<div class=\"mv-track-row\">';\n                            html += '<span class=\"mv-track-name\">' + (t.trackName || '住') + '</span>';\n                            html += '<span class=\"mv-track-yield ' + cls + '\">' + pfx + ytd.toFixed(1) + '%</span>';\n                            html += '</div>';\n                        });\n                    }\n                    html += '</div>';\n                    \n                    if (hasRec) {\n                        html += '<div class=\"mv-hint\"><i class=\"fas fa-lightbulb\"></i>';\n                        html += '<span>爪专  砖 驻砖专转 砖拽注 住驻转 注 转 砖驻专 转 爪注 转拽 - 注 ,  爪驻  砖.</span></div>';\n                    }\n                    \n                    html += '</div>';\n                });\n                \n                html += '</div></div>';\n            });\n            \n            container.innerHTML = html;\n        }\n\n    \n\n    function mvGoHome() {\n        document.body.classList.remove('mobile-active');\n        document.getElementById('mobile-view').style.display = 'none';\n        document.querySelector('.cover-section').style.display = '';\n        window.scrollTo(0, 0);\n    }\n\n    function mvGoToPension() {\n        const mobileView = document.getElementById('mobile-view');\n        const detailedReport = document.getElementById('detailed-report');\n        const insuranceReport = document.getElementById('insurance-report-content');\n        const coverSection = document.querySelector('.cover-section');\n        \n        if (coverSection) coverSection.style.display = 'none';\n        if (detailedReport) detailedReport.style.display = 'none';\n        if (insuranceReport) insuranceReport.style.display = 'none';\n        if (mobileView) mobileView.style.display = '';\n        document.body.classList.add('mobile-active');\n        \n        document.querySelectorAll('.mv-nav-item').forEach(btn => btn.classList.remove('active'));\n        event.currentTarget.classList.add('active');\n        window.scrollTo(0, 0);\n    }\n\n    function mvGoToInsurance() {\n        const mobileView = document.getElementById('mobile-view');\n        const detailedReport = document.getElementById('detailed-report');\n        const insuranceReport = document.getElementById('insurance-report-content');\n        const coverSection = document.querySelector('.cover-section');\n        \n        if (coverSection) coverSection.style.display = 'none';\n        if (mobileView) mobileView.style.display = 'none';\n        if (detailedReport) detailedReport.style.display = 'none';\n        if (insuranceReport) {\n            insuranceReport.style.display = '';\n        }\n        \n        document.querySelectorAll('.mv-nav-item').forEach(btn => btn.classList.remove('active'));\n        event.currentTarget.classList.add('active');\n        window.scrollTo(0, 0);\n    }\n\n    </script>\n\n</body>\n</html>`;\n\nreturn { json: { htmlReport: html, customerInfo: data.customerInfo, stats: { grandTotal, totalWeightedYield, avgExpTotal } } };\n"
      },
      "id": "b32a7b2a-054f-4a0e-a085-fa340b68c5c9",
      "name": "Format HTML Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33344,
        30624
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.htmlReport }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "a6b5e516-0a0b-4931-8ac5-76ddce1e68ca",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        33744,
        30704
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== INSURANCE REPORT - Policy Accordion with Covers =====\nconst inputData = $input.first().json;\nconst shuranceData = inputData.body || inputData;\nconst allProducts = shuranceData.body?.products || shuranceData.products || [];\n\nconst customerName = inputData.customerName || shuranceData.customerName || '拽';\nconst currentDate = new Date().toLocaleDateString('he-IL');\n\nconst insuranceProducts = allProducts.filter(p => {\n    const group = p.type?.group;\n    const hasCovers = p.covers && p.covers.length > 0;\n    const statusDesc = p.status?.description || '';\n    const isCancelled = statusDesc === '' || statusDesc.includes('');\n    return hasCovers && !isCancelled && (group === '专转' || group === '');\n});\n\nconst COMPANY_NAMES = {\n    1: '专', 12: '驻拽住', 15: '', 16: '砖专', 17: '专',\n    25: '专', 28: '', 48: '', 50: '', 51: '',\n    61: ' 砖专', 87: '转'\n};\n\nconst COVERAGE_CATEGORIES = [\n    { id: 'life', name: ' ', keywords: ['', '专住拽', '转'] },\n    { id: 'health', name: ' 专转', keywords: ['专转', '专驻', '砖转转', '转', '转专驻转', '砖驻'] },\n    { id: 'critical', name: ' 拽砖', keywords: [' 拽砖', '转 拽砖转', ' '] },\n    { id: 'nursing', name: '住注', keywords: ['住注', '住注'] },\n    { id: 'disability', name: ' 砖专 注', keywords: [' 砖专', '\"注', '转', ' 砖专'] }\n];\n\nfunction detectCoverage(text) {\n    if (!text) return [];\n    const found = [];\n    COVERAGE_CATEGORIES.forEach(cat => {\n        if (cat.keywords.some(kw => text.includes(kw))) found.push(cat.id);\n    });\n    return found;\n}\n\nfunction formatCurrency(num) {\n    return new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(num || 0);\n}\n\nfunction formatDate(dateStr) {\n    if (!dateStr) return '-';\n    try { return new Date(dateStr).toLocaleDateString('he-IL'); } catch { return '-'; }\n}\n\n\nfunction renderInsMutavimIcon(mutavim, policyId) {\n    if (!mutavim || mutavim.length === 0) return '';\n    const modalId = 'ins-mutavim-' + policyId;\n    const rows = mutavim.map(m => {\n        const name = ((m.shemPrati || '') + ' ' + (m.shemMishpaha || '')).trim();\n        const id = m.misparMezahe || m.misparZihuy || '-';\n        const percent = m.ahuzMutav ? (m.ahuzMutav * 100).toFixed(0) + '%' : '-';\n        const purpose = m.mahutMutav?.description || '';\n        return '<div class=\"ins-mm-item\"><div><div class=\"ins-mm-name\">' + (name || ' 爪') + '</div><div class=\"ins-mm-id\">转.: ' + id + '</div>' + (purpose ? '<div class=\"ins-mm-purpose\">' + purpose + '</div>' : '') + '</div><div class=\"ins-mm-percent\">' + percent + '</div></div>';\n    }).join('');\n    return '<span class=\"ins-mutavim-btn\" onclick=\"showInsMutavim(\\'' + modalId + '\\'); event.stopPropagation();\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"9\" cy=\"7\" r=\"4\"/><path d=\"M23 21v-2a4 4 0 0 0-3-3.87\"/><path d=\"M16 3.13a4 4 0 0 1 0 7.75\"/></svg></span><div id=\"' + modalId + '\" class=\"ins-mm-modal\" onclick=\"closeInsMutavim(\\'' + modalId + '\\')\"><div class=\"ins-mm-content\" onclick=\"event.stopPropagation()\"><div class=\"ins-mm-header\"><h3> </h3><button class=\"ins-mm-close\" onclick=\"closeInsMutavim(\\'' + modalId + '\\')\">&times;</button></div><div class=\"ins-mm-body\">' + rows + '</div></div></div>';\n}\n\nlet insuranceHtml = '';\n\nif (insuranceProducts.length > 0) {\n    const insuredMap = new Map();\n    let totalPremium = 0;\n\n    insuranceProducts.forEach(product => {\n        const companyName = COMPANY_NAMES[product.companyId] || product.companyName || '专';\n        const policyNumber = product.accountPolicyNumber || '-';\n        const productName = product.shemTohnit || '驻住';\n        const productGroup = product.type?.group || '';\n        const hasPledge = product.shiabud === true;\n        const joinDate = product.policyStartDate || product.startDate || '';\n        const status = product.status?.description || '驻注';\n\n        const coversByInsured = {};\n        product.covers.forEach(cover => {\n            const insuredId = cover.insuredIdNumber || 'unknown';\n            if (!coversByInsured[insuredId]) {\n                coversByInsured[insuredId] = {\n                    insuredId,\n                    insuredName: cover.insuredFullName,\n                    insuredTypeCode: cover.insuredType?.code || 99,\n                    insuredTypeDesc: cover.insuredType?.description || '',\n                    covers: []\n                };\n            }\n            coversByInsured[insuredId].covers.push(cover);\n        });\n\n        Object.values(coversByInsured).forEach(insuredData => {\n            const { insuredId, insuredName, insuredTypeCode, insuredTypeDesc, covers } = insuredData;\n\n            let name = insuredName;\n            if (!name) {\n                if (insuredTypeCode === 1) name = customerName;\n                else if (insuredTypeCode === 2) name = '/转 ';\n                else name = '/';\n            }\n\n            if (!insuredMap.has(insuredId)) {\n                insuredMap.set(insuredId, {\n                    id: insuredId, name, typeCode: insuredTypeCode,\n                    typeDesc: insuredTypeDesc, policies: [], totalPremium: 0,\n                    coverageSet: new Set()\n                });\n            }\n\n            const insured = insuredMap.get(insuredId);\n            if (insuredName) insured.name = insuredName;\n\n            let policyPremium = 0;\n            const coverDetails = covers.map(cover => {\n                const premium = cover.premia || 0;\n                policyPremium += premium;\n                totalPremium += premium;\n\n                const allText = (cover.coverDescription || '') + ' ' + (cover.coverTypeDescription || '') + ' ' + productGroup;\n                detectCoverage(allText).forEach(cid => insured.coverageSet.add(cid));\n                if (productGroup === '') insured.coverageSet.add('life');\n                if (productGroup === '专转') insured.coverageSet.add('health');\n\n                return {\n                    coverTypeDescription: cover.coverTypeDescription || '',\n                    coverDescription: cover.coverDescription || '',\n                    coverAmount: cover.insuranceAmount || 0,\n                    premium\n                };\n            });\n\n            insured.totalPremium += policyPremium;\n\n            // Get primary cover type for policy header\n            const primaryCoverType = covers[0]?.coverTypeDescription || productGroup;\n            const primaryCoverAmount = covers.reduce((sum, c) => sum + (c.coverAmount || 0), 0);\n\n            // Get mutavim (beneficiaries) from product\n            const mutavim = product.mutavim || [];\n\n            insured.policies.push({\n                policyNumber, companyName, productName, productGroup,\n                primaryCoverType,\n                coverAmount: primaryCoverAmount,\n                totalPremium: policyPremium, hasPledge, joinDate, status,\n                covers: coverDetails,\n                mutavim: mutavim\n            });\n        });\n    });\n\n    const sortedInsured = Array.from(insuredMap.values()).sort((a, b) => {\n        if (a.typeCode === 1) return -1;\n        if (b.typeCode === 1) return 1;\n        if (a.typeCode === 2) return -1;\n        if (b.typeCode === 2) return 1;\n        return a.typeCode - b.typeCode;\n    });\n\n    // Tabs\n    let tabsHtml = '';\n    sortedInsured.forEach((ins, i) => {\n        const isActive = i === 0 ? ' active' : '';\n        const icon = ins.typeCode <= 2 ? '' : '';\n        tabsHtml += '<button class=\"ins-tab' + isActive + '\" data-tab=\"ins-' + i + '\">' + icon + ' ' + ins.name + '</button>';\n    });\n    tabsHtml += '<button class=\"ins-tab\" data-tab=\"summary\"> 住</button>';\n\n    // Content per insured\n    let contentHtml = '';\n    let policyCounter = 0;\n\n    sortedInsured.forEach((ins, i) => {\n        const isActive = i === 0 ? ' active' : '';\n\n        // Coverage map\n        let coverageMapHtml = COVERAGE_CATEGORIES.map(cat => {\n            const hasCoverage = ins.coverageSet.has(cat.id);\n            return `<div class=\"ins-cov-item ${hasCoverage ? 'ins-cov-yes' : 'ins-cov-no'}\">\n                <span class=\"ins-cov-icon\">${hasCoverage ? '' : ''}</span>\n                <span class=\"ins-cov-name\">${cat.name}</span>\n            </div>`;\n        }).join('');\n\n        // Group by type\n        const byType = {};\n        ins.policies.forEach(p => {\n            if (!byType[p.productGroup]) byType[p.productGroup] = [];\n            byType[p.productGroup].push(p);\n        });\n\n        let typeSections = '';\n        Object.entries(byType).forEach(([typeName, policies]) => {\n            let policiesHtml = policies.map(p => {\n                const policyId = 'policy-' + (policyCounter++);\n                const mutavimIcon = renderInsMutavimIcon(p.mutavim, policyId);\n                const pledgeIcon = p.hasPledge ? ' <span class=\"ins-pledge-warn\" title=\"拽 砖注\">锔</span>' : '';\n\n                const coversHtml = p.covers.map(c => `\n                    <div class=\"ins-cover-row\">\n                        <div class=\"ins-cover-cell\">${c.coverTypeDescription || '-'}</div>\n                        <div class=\"ins-cover-cell ins-cover-desc\">${c.coverDescription || '-'}</div>\n                        <div class=\"ins-cover-cell\">${c.coverAmount > 0 ? formatCurrency(c.coverAmount) : '-'}</div>\n                        <div class=\"ins-cover-cell\">${formatCurrency(c.premium)}</div>\n                    </div>\n                `).join('');\n\n                return `\n                <div class=\"ins-policy-card\" id=\"${policyId}\">\n                    <div class=\"ins-policy-header\" onclick=\"toggleInsPolicy('${policyId}')\">\n                        <div class=\"ins-ph-chevron\"></div>\n                        <div class=\"ins-ph-policy\">${p.policyNumber}${pledgeIcon}</div>\n                        <div class=\"ins-ph-product\">${p.primaryCoverType}${mutavimIcon}</div>\n                        <div class=\"ins-ph-company\">${p.companyName}</div>\n                        <div class=\"ins-ph-amount\">${p.coverAmount > 0 ? formatCurrency(p.coverAmount) : '-'}</div>\n                        <div class=\"ins-ph-premium\">${formatCurrency(p.totalPremium)}</div>\n                        <div class=\"ins-ph-status\"><span class=\"ins-status-badge\">${p.status}</span></div>\n                    </div>\n                    <div class=\"ins-policy-body\">\n                        ${p.hasPledge ? '<div class=\"ins-pledge-notice-box\">锔 拽 砖注 注 驻住 </div>' : ''}\n                        <div class=\"ins-covers-table\">\n                            <div class=\"ins-covers-header\">\n                                <div class=\"ins-ch-cell\">住 住</div>\n                                <div class=\"ins-ch-cell\">转专</div>\n                                <div class=\"ins-ch-cell\">住 </div>\n                                <div class=\"ins-ch-cell\">驻专</div>\n                            </div>\n                            ${coversHtml}\n                        </div>\n                        \n                    </div>\n                </div>`;\n            }).join('');\n\n            typeSections += `\n                <div class=\"ins-type-section\">\n                    <div class=\"ins-type-title\">${typeName} (${policies.length})</div>\n                    <div class=\"ins-policies-header\">\n                        <div></div>\n                        <div>砖/驻住</div>\n                        <div>爪专</div>\n                        <div>爪专</div>\n                        <div>住 </div>\n                        <div>驻专</div>\n                        <div>住住</div>\n                    </div>\n                    ${policiesHtml}\n                </div>`;\n        });\n\n        contentHtml += `\n            <div class=\"ins-content${isActive}\" id=\"tab-ins-${i}\">\n                <div class=\"ins-person-bar\">\n                    <div class=\"ins-person-info\">\n                        <span class=\"ins-person-name\">${ins.name}</span>\n                        <span class=\"ins-person-type\">${ins.typeDesc}</span>\n                    </div>\n                    <div class=\"ins-person-total\">${formatCurrency(ins.totalPremium)}/砖</div>\n                </div>\n                <div class=\"ins-coverage-map\">\n                    <div class=\"ins-cov-title\">驻转 住</div>\n                    <div class=\"ins-cov-grid\">${coverageMapHtml}</div>\n                </div>\n                ${typeSections}\n            </div>`;\n    });\n\n    // Summary\n    const legendHtml = COVERAGE_CATEGORIES.map(cat => `<span class=\"ins-legend-item\">${cat.name}</span>`).join('');\n    let summaryContent = sortedInsured.map((ins, i) => {\n        const coverageIcons = COVERAGE_CATEGORIES.map(cat => {\n            const has = ins.coverageSet.has(cat.id);\n            return `<span class=\"ins-sum-cov ${has ? 'yes' : 'no'}\" title=\"${cat.name}\">${has ? '' : ''}</span>`;\n        }).join('');\n        return `\n        <div class=\"ins-summary-row\" onclick=\"switchInsTab('ins-${i}')\">\n            <div class=\"ins-sum-person\"><span class=\"ins-sum-icon\">${ins.typeCode <= 2 ? '' : ''}</span><span class=\"ins-sum-name\">${ins.name}</span></div>\n            <div class=\"ins-sum-coverages\">${coverageIcons}</div>\n            <div class=\"ins-sum-premium\">${formatCurrency(ins.totalPremium)}/砖</div>\n        </div>`;\n    }).join('');\n\n    insuranceHtml = `\n<style>\n.ins-report{max-width:900px;margin:0 auto;padding:0 16px;font-family:'Assistant',sans-serif;direction:rtl}\n.ins-report .ins-header{background:#0f172a;color:#fff;padding:20px 24px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}\n.ins-report .ins-brand{display:flex;align-items:center;gap:12px}\n.ins-report .ins-brand-icon{width:44px;height:44px;background:rgba(255,255,255,.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}\n.ins-report .ins-brand h1{font-size:20px;margin:0}.ins-report .ins-brand p{font-size:12px;opacity:.7;margin:0}\n.ins-report .ins-client{text-align:left}.ins-report .ins-client-name{font-size:16px;font-weight:700}.ins-report .ins-client-date{font-size:11px;opacity:.7}\n\n.ins-report .ins-tabs{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}\n.ins-report .ins-tab{padding:10px 18px;border:2px solid #e2e8f0;border-radius:20px;background:#fff;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;white-space:nowrap;transition:all .2s;font-family:inherit}\n.ins-report .ins-tab:hover{border-color:#1e3a8a;color:#1e3a8a}\n.ins-report .ins-tab.active{background:#1e3a8a;border-color:#1e3a8a;color:#fff}\n\n.ins-report .ins-content{display:none}.ins-report .ins-content.active{display:block}\n\n.ins-report .ins-person-bar{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#f8fafc;border-radius:8px;margin-bottom:16px}\n.ins-report .ins-person-info{display:flex;align-items:center;gap:12px}\n.ins-report .ins-person-name{font-size:18px;font-weight:700;color:#1e293b}\n.ins-report .ins-person-type{font-size:12px;color:#64748b;background:#e2e8f0;padding:4px 12px;border-radius:12px}\n.ins-report .ins-person-total{font-size:18px;font-weight:700;color:#1e3a8a}\n\n.ins-report .ins-coverage-map{background:linear-gradient(135deg,#1e3a8a,#3b82f6);padding:20px;border-radius:12px;margin-bottom:20px}\n.ins-report .ins-cov-title{color:#fff;font-size:14px;font-weight:600;margin-bottom:12px;opacity:.9}\n.ins-report .ins-cov-grid{display:flex;flex-wrap:wrap;gap:10px}\n.ins-report .ins-cov-item{display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;min-width:140px}\n.ins-report .ins-cov-yes{background:rgba(34,197,94,.2);color:#86efac}\n.ins-report .ins-cov-no{background:rgba(239,68,68,.15);color:#fca5a5}\n.ins-report .ins-cov-icon{font-size:16px;font-weight:700}\n\n.ins-report .ins-type-section{margin-bottom:24px}\n.ins-report .ins-policies-header{display:grid;grid-template-columns:24px 110px 150px 80px 110px 90px 70px;gap:8px;padding:10px 16px;font-size:11px;font-weight:600;color:#64748b;background:#f1f5f9;border-bottom:1px solid #e2e8f0}\n.ins-report .ins-type-title{font-size:15px;font-weight:700;color:#1e293b;padding:10px 0;border-bottom:2px solid #e2e8f0;margin-bottom:12px}\n\n/* Policy Card */\n.ins-report .ins-policy-card{background:#fff;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;overflow:hidden}\n.ins-report .ins-policy-header{display:grid;grid-template-columns:24px 110px 150px 80px 110px 90px 70px;gap:8px;padding:14px 16px;align-items:center;cursor:pointer;transition:background .15s;font-size:13px}\n.ins-report .ins-policy-header:hover{background:#f8fafc}\n.ins-report .ins-ph-chevron{color:#94a3b8;font-size:12px;transition:transform .2s}\n.ins-report .ins-ph-policy{font-weight:600;color:#3b82f6}\n.ins-report .ins-ph-product{color:#1e293b;font-weight:500}\n.ins-report .ins-ph-company{color:#64748b}\n.ins-report .ins-ph-amount{color:#64748b}\n.ins-report .ins-ph-premium{font-weight:700;color:#1e3a8a}\n.ins-report .ins-ph-status{text-align:center}\n.ins-report .ins-status-badge{background:#dcfce7;color:#166534;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:600}\n.ins-report .ins-pledge-warn{color:#f59e0b;cursor:help}\n\n.ins-report .ins-policy-body{display:none;background:#f8fafc;border-top:1px solid #e2e8f0}\n.ins-report .ins-policy-card.ins-open .ins-policy-body{display:block}\n.ins-report .ins-policy-card.ins-open .ins-ph-chevron{transform:rotate(-90deg)}\n.ins-report .ins-policy-card.ins-open .ins-policy-header{background:#f1f5f9}\n\n.ins-report .ins-pledge-notice-box{margin:12px 16px;padding:10px 14px;background:#fef3c7;border:1px solid #fcd34d;border-radius:6px;color:#92400e;font-size:13px;font-weight:600}\n\n/* Covers Table */\n.ins-report .ins-covers-table{margin:12px;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}\n.ins-report .ins-covers-header{display:grid;grid-template-columns:130px 1fr 110px 90px;gap:12px;padding:10px 16px;font-size:11px;font-weight:600;color:#64748b;background:#f1f5f9}\n.ins-report .ins-cover-row{display:grid;grid-template-columns:130px 1fr 110px 90px;gap:12px;padding:12px 16px;font-size:13px;border-bottom:1px solid #e2e8f0}\n.ins-report .ins-cover-row:last-child{border-bottom:none}\n.ins-report .ins-cover-cell{color:#1e293b}\n.ins-report .ins-cover-desc{color:#64748b}\n\n/* Summary */\n.ins-report .ins-summary-legend{display:flex;justify-content:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}\n.ins-report .ins-legend-item{font-size:11px;color:#64748b;padding:4px 8px;background:#f1f5f9;border-radius:4px}\n.ins-report .ins-summary-row{display:grid;grid-template-columns:1fr auto 130px;gap:16px;align-items:center;padding:14px 20px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .2s}\n.ins-report .ins-summary-row:hover{border-color:#1e3a8a;box-shadow:0 2px 8px rgba(0,0,0,.05)}\n.ins-report .ins-sum-person{display:flex;align-items:center;gap:10px}\n.ins-report .ins-sum-icon{font-size:18px}.ins-report .ins-sum-name{font-size:14px;font-weight:600;color:#1e293b}\n.ins-report .ins-sum-coverages{display:flex;gap:4px}\n.ins-report .ins-sum-cov{width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:6px;font-size:13px;font-weight:700}\n.ins-report .ins-sum-cov.yes{background:#dcfce7;color:#166534}\n.ins-report .ins-sum-cov.no{background:#fee2e2;color:#dc2626}\n.ins-report .ins-sum-premium{font-size:14px;font-weight:700;color:#1e3a8a}\n\n/* Mutavim (Beneficiaries) */\n.ins-report .ins-mutavim-section{margin:12px 16px 16px;padding:14px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:8px;border:1px solid #fcd34d}\n.ins-report .ins-mutavim-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}\n.ins-report .ins-mutavim-icon{font-size:18px}\n.ins-report .ins-mutavim-title{font-size:14px;font-weight:700;color:#92400e}\n.ins-report .ins-mutavim-list{display:flex;flex-direction:column;gap:6px}\n.ins-mutavim-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:4px;background:linear-gradient(135deg,#fef3c7,#fde68a);color:#92400e;cursor:pointer;transition:all 0.2s;margin-right:6px;border:1px solid #f59e0b}\n.ins-mutavim-btn:hover{background:linear-gradient(135deg,#fde68a,#fbbf24);transform:scale(1.1)}\n.ins-mm-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}\n.ins-mm-modal.open{display:flex}\n.ins-mm-content{background:#fff;border-radius:12px;width:90%;max-width:400px;box-shadow:0 15px 40px rgba(0,0,0,0.2);overflow:hidden}\n.ins-mm-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#78350f}\n.ins-mm-header h3{font-size:15px;font-weight:700;margin:0}\n.ins-mm-close{background:rgba(255,255,255,0.3);border:none;color:#78350f;width:26px;height:26px;border-radius:6px;font-size:18px;cursor:pointer}\n.ins-mm-body{padding:14px;background:linear-gradient(135deg,#fffbeb,#fef3c7);display:flex;flex-direction:column;gap:8px}\n.ins-mm-item{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px;background:#fff;border-radius:8px;border:1px solid #fde68a;align-items:center}\n.ins-mm-name{font-size:14px;font-weight:700;color:#1f2937}\n.ins-mm-id{font-size:11px;color:#6b7280;margin-top:2px;font-family:monospace}\n.ins-mm-purpose{font-size:10px;color:#92400e;margin-top:2px}\n.ins-mm-percent{font-size:20px;font-weight:800;color:#d97706}\n.ins-report .ins-mutav-row{display:grid;grid-template-columns:1fr 100px 140px 60px;gap:12px;padding:8px 12px;background:rgba(255,255,255,.7);border-radius:6px;font-size:13px}\n.ins-report .ins-mutav-name{font-weight:600;color:#1e293b}\n.ins-report .ins-mutav-relation{color:#64748b}\n.ins-report .ins-mutav-purpose{color:#78350f;font-size:12px}\n.ins-report .ins-mutav-percent{font-weight:600;color:#92400e;text-align:left}\n\n@media(max-width:768px){\n.ins-report .ins-header{flex-direction:column;gap:12px;text-align:center}\n.ins-report .ins-client{text-align:center}\n.ins-report .ins-cov-grid{flex-direction:column}\n.ins-report .ins-policy-header{grid-template-columns:30px 1fr auto auto}\n.ins-report .ins-ph-product,.ins-report .ins-ph-company{display:none}\n.ins-report .ins-covers-header,.ins-report .ins-cover-row{grid-template-columns:1fr 80px}\n.ins-report .ins-covers-header>div:nth-child(1),.ins-report .ins-covers-header>div:nth-child(3),\n.ins-report .ins-cover-row>div:nth-child(1),.ins-report .ins-cover-row>div:nth-child(3){display:none}\n}\n</style>\n\n<div class=\"ins-report\">\n    <header class=\"ins-header\">\n        <div class=\"ins-brand\">\n            <div class=\"ins-brand-icon\"><i class=\"fas fa-shield-alt\"></i></div>\n            <div><h1>Portfolio Expert</h1><p> 住 </p></div>\n        </div>\n        <div class=\"ins-client\">\n            <div class=\"ins-client-name\">${customerName}</div>\n            <div class=\"ins-client-date\"> -${currentDate}</div>\n        </div>\n    </header>\n\n    <div class=\"ins-tabs\">${tabsHtml}</div>\n    ${contentHtml}\n    <div class=\"ins-content\" id=\"tab-summary\">\n        <div class=\"ins-summary-legend\">${legendHtml}</div>\n        ${summaryContent}\n    </div>\n</div>\n\n<script>\nfunction switchInsTab(t){\n    document.querySelectorAll('.ins-report .ins-tab').forEach(x=>x.classList.remove('active'));\n    document.querySelectorAll('.ins-report .ins-content').forEach(x=>x.classList.remove('active'));\n    document.querySelector('.ins-report [data-tab=\"'+t+'\"]').classList.add('active');\n    document.getElementById('tab-'+t).classList.add('active');\n}\ndocument.querySelectorAll('.ins-report .ins-tab').forEach(t=>t.addEventListener('click',()=>switchInsTab(t.dataset.tab)));\n\nfunction showInsMutavim(id){var m=document.getElementById(id);if(m)m.classList.add('open');event.stopPropagation();}\nfunction closeInsMutavim(id){var m=document.getElementById(id);if(m)m.classList.remove('open');event.stopPropagation();}\nfunction toggleInsPolicy(id){\n    const el = document.getElementById(id);\n    if(el) el.classList.toggle('ins-open');\n}\n</script>`;\n}\n\nreturn { json: { insuranceHtml } };"
      },
      "id": "4ad9ef42-15ae-41a8-adb2-1418fe471bd1",
      "name": "Format Insurance Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32224,
        30928
      ]
    },
    {
      "parameters": {
        "jsCode": "// Combine Pension HTML and Insurance HTML\nconsole.log('=== Combine Reports START ===');\nconst inputs = $input.all();\nconsole.log('Number of inputs:', inputs.length);\n\nlet pensionHtml = '';\nlet insuranceHtml = '';\n\ninputs.forEach((item, idx) => {\n    console.log('Input', idx, 'keys:', Object.keys(item.json));\n    if (item.json.htmlReport) {\n        pensionHtml = item.json.htmlReport;\n        console.log('Found pensionHtml, length:', pensionHtml.length);\n    }\n    if (item.json.insuranceHtml) {\n        insuranceHtml = item.json.insuranceHtml;\n        console.log('Found insuranceHtml, length:', insuranceHtml.length);\n    }\n});\n\n// Insert insurance HTML wrapped in a hideable container\nlet finalHtml = pensionHtml;\nif (insuranceHtml && pensionHtml) {\n    console.log('Merging pension and insurance HTML');\n    \n    // Wrap insurance HTML with a container that's hidden by default\n    const wrappedInsuranceHtml = '<div id=\"insurance-report-content\" style=\"display: none;\">' + insuranceHtml + '</div>';\n    \n    // Find the floating-footer and insert insurance before it\n    const footerIdx = pensionHtml.indexOf('<div class=\"floating-footer');\n    if (footerIdx > -1) {\n        finalHtml = pensionHtml.slice(0, footerIdx) + wrappedInsuranceHtml + pensionHtml.slice(footerIdx);\n        console.log('Inserted before floating-footer');\n    } else {\n        // Fallback: insert before </body>\n        finalHtml = pensionHtml.replace('</body>', wrappedInsuranceHtml + '</body>');\n        console.log('Inserted before </body>');\n    }\n} else {\n    console.log('Missing HTML - pension:', !!pensionHtml, 'insurance:', !!insuranceHtml);\n}\n\nconsole.log('Final HTML length:', finalHtml.length);\nconsole.log('=== Combine Reports END ===');\nreturn { json: { htmlReport: finalHtml } };"
      },
      "id": "5f28878a-80c0-4b33-9a0b-0dbdcfe2dd10",
      "name": "Combine Reports",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33328,
        30720
      ]
    },
    {
      "parameters": {},
      "id": "85d46003-bf76-4f2f-b875-6fd360a483b0",
      "name": "Wait For Both",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        33120,
        30720
      ]
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "ba9510ae-a8f1-4852-80d3-4ea69f57b32a",
              "name": "marketTrendsText",
              "value": " 砖专 驻转转 转 2026 注爪: 转\"-125 注 4.7%, 转\"-90 拽 5.6%. 砖拽 转拽 -3.15 砖\". 拽 砖专 专 专转 -4% 注 转转 -3.5% 砖 拽专.\n\n吼 专\": S&P 500 注 1.6%, 住\"拽 1.9%. 砖拽 注 砖 注 50 祝 砖专转 爪专.\n\n 住专: 注 专转 专转 - \" 专 转 专 砖注转转.",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "88d9d051-b6a8-441c-bfd2-4e685572b6fc",
      "name": "Market Trends",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        33144,
        30624
      ]
    },
    {
      "parameters": {
        "jsCode": "// Create company API calls from track results\nconst trackResults = $('Parse Bituach Results').all();\nconst companyCallsMap = new Map();\n\nfor (const item of trackResults) {\n  const track = item.json;\n  const parentCompanyLegalId = track.parentCompanyLegalId;\n  const fundClassification = track.fundClassification;\n  \n  if (parentCompanyLegalId && !companyCallsMap.has(parentCompanyLegalId)) {\n    companyCallsMap.set(parentCompanyLegalId, {\n      parentCompanyLegalId,\n      companyName: track.managingCorp || track.companyName,\n      fundClassification,\n      productTypeCode: track.productTypeCode,\n      customerTrackCodes: [String(track.trackCode)],\n      apiUrl: 'https://data.gov.il/api/3/action/datastore_search?resource_id=c6c62cc7-fe02-4b18-8f3e-813abfbb4647&filters=' + encodeURIComponent(JSON.stringify({ PARENT_COMPANY_LEGAL_ID: parentCompanyLegalId, FUND_CLASSIFICATION: fundClassification })) + '&sort=REPORT_PERIOD%20desc&limit=100'\n    });\n  } else if (parentCompanyLegalId) {\n    const existing = companyCallsMap.get(parentCompanyLegalId);\n    if (!existing.customerTrackCodes.includes(String(track.trackCode))) {\n      existing.customerTrackCodes.push(String(track.trackCode));\n    }\n  }\n}\n\nconst calls = Array.from(companyCallsMap.values());\nreturn calls.length > 0 ? calls.map(c => ({ json: c })) : [{ json: { noCompanyCalls: true } }];"
      },
      "id": "465404b6-6361-4ff0-bf76-cea8aa17b72b",
      "name": "Create Company Calls",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32750,
        31100
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.apiUrl }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "df07ea82-3ef6-4266-9ae8-92b34f1a0f21",
      "name": "Bituach Company API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32950,
        31100
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build Bituach Recommendations - like GemelNet logic\nconst results = [];\nconst trackResults = $('Parse Bituach Results').all().map(i => i.json);\nconst companyInputs = $('Create Company Calls').all();\n\nfor (let i = 0; i < $input.all().length; i++) {\n  const item = $input.all()[i];\n  const companyInfo = companyInputs[i]?.json || {};\n  \n  if (companyInfo.noCompanyCalls) continue;\n  \n  const records = item.json?.result?.records || [];\n  const customerTrackCodes = companyInfo.customerTrackCodes || [];\n  \n  // Build allTracks from company records (latest per FUND_ID)\n  const latestByFundId = {};\n  for (const rec of records) {\n    const fundId = String(rec.FUND_ID);\n    if (!latestByFundId[fundId] || rec.REPORT_PERIOD > latestByFundId[fundId].REPORT_PERIOD) {\n      latestByFundId[fundId] = rec;\n    }\n  }\n  \n  const allTracks = Object.values(latestByFundId).map(rec => {\n    const assets = parseFloat(rec.TOTAL_ASSETS || 1);\n    const exposure = parseFloat(rec.STOCK_MARKET_EXPOSURE || 0);\n    return {\n      fundId: String(rec.FUND_ID),\n      fundName: rec.FUND_NAME || '',\n      ytdYield: parseFloat(rec.YEAR_TO_DATE_YIELD || 0),\n      yield3Y: parseFloat(rec.AVG_ANNUAL_YIELD_TRAILING_3YRS || 0),\n      stockExposure: assets > 0 ? (exposure / assets) * 100 : 0,\n      totalAssets: assets,\n      managingCorp: rec.MANAGING_CORPORATION || rec.PARENT_COMPANY_NAME || '',\n      fundClassification: rec.FUND_CLASSIFICATION || '',\n      mgmtFee: parseFloat(rec.AVG_ANNUAL_MANAGEMENT_FEE || 0)\n    };\n  });\n  \n  // Sort by yield (high to low)\n  allTracks.sort((a, b) => b.ytdYield - a.ytdYield);\n  \n  // Top 3\n  const top3 = allTracks.slice(0, 3).map((t, idx) => ({ ...t, rank: idx + 1 }));\n  \n  // For each customer track, build recommendations\n  for (const trackCode of customerTrackCodes) {\n    const originalTrack = trackResults.find(t => String(t.trackCode) === trackCode);\n    if (!originalTrack) continue;\n    \n    const companyTrack = allTracks.find(t => t.fundId === trackCode);\n    const rankIndex = allTracks.findIndex(t => t.fundId === trackCode);\n    const ranking = rankIndex >= 0 ? rankIndex + 1 : null;\n    \n    // Alert logic: not in top 3 + similar exposure (卤15%) + yield diff >= 7%\n    let hasAlert = false;\n    let betterTrack = null;\n    \n    const currentExposure = originalTrack.stockExposure || companyTrack?.stockExposure || 0;\n    const currentYield = originalTrack.ytdYield || 0;\n    \n    if (ranking > 3) {\n      for (const track of allTracks) {\n        if (track.fundId === trackCode) continue;\n        const exposureDiff = Math.abs(track.stockExposure - currentExposure);\n        const yieldDiff = track.ytdYield - currentYield;\n        \n        if (exposureDiff <= 15 && yieldDiff >= 7) {\n          hasAlert = true;\n          betterTrack = track;\n          break;\n        }\n      }\n    }\n    \n    results.push({\n      json: {\n        ...originalTrack,\n        ranking,\n        totalTracks: allTracks.length,\n        top3,\n        allTracks,\n        hasAlert,\n        betterTrack,\n        source: 'BITUACHNET'\n      }\n    });\n  }\n}\n\n// Add any tracks without company data (pass through)\nfor (const track of trackResults) {\n  const alreadyProcessed = results.some(r => String(r.json.trackCode) === String(track.trackCode));\n  if (!alreadyProcessed) {\n    results.push({\n      json: {\n        ...track,\n        ranking: null,\n        totalTracks: null,\n        top3: [],\n        allTracks: [],\n        hasAlert: false,\n        betterTrack: null\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "57c6b85e-bc16-4dda-8a01-4cb32536af5e",
      "name": "Build Bituach Recommendations",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        33150,
        31100
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Portfolio + Alerts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Format Insurance Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Portfolio + Alerts": {
      "main": [
        [
          {
            "node": "If Gemel Net Needed",
            "type": "main",
            "index": 0
          },
          {
            "node": "If Pension Net Needed",
            "type": "main",
            "index": 0
          },
          {
            "node": "If Bituach Net Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Gemel Net Needed": {
      "main": [
        [
          {
            "node": "Split Gemel Tracks",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Market Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Pension Net Needed": {
      "main": [
        [
          {
            "node": "Split Pension Tracks",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Market Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "If Bituach Net Needed": {
      "main": [
        [
          {
            "node": "Split Bituach Tracks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Gemel Tracks": {
      "main": [
        [
          {
            "node": "Gemel Net API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Pension Tracks": {
      "main": [
        [
          {
            "node": "Pension Net API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Bituach Tracks": {
      "main": [
        [
          {
            "node": "Bituach Net API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemel Net API": {
      "main": [
        [
          {
            "node": "Parse Gemel Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pension Net API": {
      "main": [
        [
          {
            "node": "Parse Pension Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bituach Net API": {
      "main": [
        [
          {
            "node": "Parse Bituach Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Gemel Results": {
      "main": [
        [
          {
            "node": "Merge Market Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Pension Results": {
      "main": [
        [
          {
            "node": "Merge Market Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Market Data": {
      "main": [
        [
          {
            "node": "Analyze Performance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Performance": {
      "main": [
        [
          {
            "node": "Market Trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format HTML Report": {
      "main": [
        [
          {
            "node": "Wait For Both",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Bituach Results": {
      "main": [
        [
          {
            "node": "Create Company Calls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Insurance Report": {
      "main": [
        [
          {
            "node": "Wait For Both",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wait For Both": {
      "main": [
        [
          {
            "node": "Combine Reports",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Reports": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Market Trends": {
      "main": [
        [
          {
            "node": "Format HTML Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Company Calls": {
      "main": [
        [
          {
            "node": "Bituach Company API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bituach Company API": {
      "main": [
        [
          {
            "node": "Build Bituach Recommendations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Bituach Recommendations": {
      "main": [
        [
          {
            "node": "Merge Market Data",
            "type": "main",
            "index": 2
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "b3efd402-81bb-4938-b715-c956a80a26cf",
  "meta": {
    "instanceId": "a67fb24ecbe47c6e08c2fdf5ea395bdba57595d4c3709dd5131ed1819ad339bf"
  },
  "id": "UJ2lOlifq2oTYL86oosPC",
  "tags": []
}